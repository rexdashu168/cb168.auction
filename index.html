<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIå¯è½‰å‚µç«¶æ‹ç³»çµ± v1.0</title>
<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AIå¯è½‰å‚µç«¶æ‹ç³»çµ± v1.0 - å°ˆæ³¨ç‰ˆ
å¾ v3.98h ç²¾ç°¡è€Œä¾†ï¼Œåªä¿ç•™ç«¶æ‹ç›¸é—œæ ¸å¿ƒåŠŸèƒ½

ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼š

1. AI ç«¶æ‹åƒ¹æ ¼é æ¸¬
1. å¿«é€Ÿé¸å–®ï¼ˆå¾…ç™¼è¡Œ/ç«¶æ‹ä¸­ï¼‰
1. å¸‚å ´æ°›åœåˆ†æ
1. ç«¶æ‹æ­·å²æŸ¥è©¢
1. ç”¢æ¥­/åˆ¸å•†çµ±è¨ˆ

ğŸ“‚ è³‡æ–™ä¾†æºï¼š

- 04_auction.csv (ç«¶æ‹æ­·å²)
- 06_issue.csv (å¾…ç™¼è¡Œ)
- 16_industry.csv (ç”¢æ¥­åˆ†é¡)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â€“>

<style>
/* ==========================================
   åŸºç¤æ¨£å¼
   ========================================== */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 15px;
}
.container {
    max-width: 1400px;
    margin: 0 auto;
}

/* ==========================================
   Header
   ========================================== */
.header {
    background: rgba(255,255,255,0.95);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 15px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.header h1 {
    font-size: 24px;
    color: #333;
    margin-bottom: 5px;
}
.header .subtitle {
    color: #666;
    font-size: 13px;
}
.header .stats-row {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}
.stat-item {
    text-align: center;
}
.stat-value {
    font-size: 28px;
    font-weight: 800;
}
.stat-label {
    font-size: 11px;
    color: #888;
}

/* ==========================================
   ä¸»è¦ä½ˆå±€
   ========================================== */
.main-grid {
    display: grid;
    grid-template-columns: 450px 1fr;
    gap: 15px;
}
@media (max-width: 1000px) {
    .main-grid { grid-template-columns: 1fr; }
}

/* ==========================================
   å¡ç‰‡æ¨£å¼
   ========================================== */
.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
}
.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 15px;
    font-weight: 700;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.card-body {
    padding: 15px;
}

/* ==========================================
   è¡¨å–®æ¨£å¼
   ========================================== */
.form-group {
    margin-bottom: 12px;
}
.form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #555;
    margin-bottom: 4px;
}
.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
}
.form-control:focus {
    outline: none;
    border-color: #667eea;
}
select.form-control {
    cursor: pointer;
}
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

/* ==========================================
   æŒ‰éˆ•æ¨£å¼
   ========================================== */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102,126,234,0.4);
}
.btn-secondary {
    background: #f5f5f5;
    color: #666;
}
.btn-secondary:hover {
    background: #e8e8e8;
}
.btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

/* ==========================================
   å¿«é€Ÿé¸å–®
   ========================================== */
.quick-select-section {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 15px;
}
.quick-select-title {
    font-size: 12px;
    font-weight: 700;
    color: #2e7d32;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 5px;
}
.quick-select-grid {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}
.quick-btn {
    padding: 6px 12px;
    border: 1px solid #81c784;
    background: white;
    border-radius: 15px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
}
.quick-btn:hover {
    background: #2e7d32;
    color: white;
    border-color: #2e7d32;
}
.quick-btn.pending {
    border-color: #ff9800;
}
.quick-btn.pending:hover {
    background: #ff9800;
    border-color: #ff9800;
}

/* ==========================================
   çµæœé¡¯ç¤º
   ========================================== */
.result-section {
    margin-top: 15px;
}
.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.result-title {
    font-size: 14px;
    font-weight: 700;
    color: #333;
}
.result-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}
.badge-success { background: #e8f5e9; color: #2e7d32; }
.badge-warning { background: #fff3e0; color: #e65100; }
.badge-danger { background: #ffebee; color: #c62828; }

/* ç­–ç•¥åƒ¹æ ¼å¡ç‰‡ */
.strategy-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
}
.strategy-card {
    padding: 12px;
    border-radius: 10px;
    text-align: center;
}
.strategy-card.conservative {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #1976d2;
}
.strategy-card.balanced {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border: 2px solid #7b1fa2;
}
.strategy-card.aggressive {
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    border: 2px solid #c62828;
}
.strategy-label {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 4px;
}
.strategy-price {
    font-size: 24px;
    font-weight: 800;
}
.strategy-desc {
    font-size: 10px;
    color: #666;
    margin-top: 4px;
}

/* ==========================================
   å¸‚å ´æ°›åœé¢æ¿
   ========================================== */
.atmosphere-panel {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 15px;
}
.atmosphere-title {
    font-size: 12px;
    font-weight: 700;
    color: #f57c00;
    margin-bottom: 8px;
}
.atmosphere-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}
.atmosphere-item {
    text-align: center;
    padding: 8px;
    background: white;
    border-radius: 8px;
}
.atmosphere-value {
    font-size: 18px;
    font-weight: 800;
}
.atmosphere-label {
    font-size: 10px;
    color: #666;
}

/* ==========================================
   æ­·å²æŸ¥è©¢è¡¨æ ¼
   ========================================== */
.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}
.history-table th {
    background: #f5f5f5;
    padding: 10px 8px;
    text-align: center;
    font-weight: 600;
    border-bottom: 2px solid #e0e0e0;
    position: sticky;
    top: 0;
}
.history-table td {
    padding: 8px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
}
.history-table tbody tr:hover {
    background: #f5f5f5;
}
.history-table .cb-code {
    color: #1565c0;
    font-weight: 700;
    cursor: pointer;
}
.history-table .cb-code:hover {
    text-decoration: underline;
}
.history-table .positive { color: #2e7d32; }
.history-table .negative { color: #c62828; }

/* æœå°‹æ¡† */
.search-box {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}
.search-input {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 13px;
}
.search-input:focus {
    outline: none;
    border-color: #667eea;
}

/* åˆ†é æ¨™ç±¤ */
.tab-nav {
    display: flex;
    border-bottom: 2px solid #e0e0e0;
    margin-bottom: 15px;
}
.tab-btn {
    padding: 10px 20px;
    border: none;
    background: none;
    font-size: 13px;
    font-weight: 600;
    color: #888;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}
.tab-btn:hover {
    color: #667eea;
}
.tab-btn.active {
    color: #667eea;
    border-bottom-color: #667eea;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}

/* çµ±è¨ˆå¡ç‰‡ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}
.stat-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 12px;
    text-align: center;
}
.stat-card-value {
    font-size: 20px;
    font-weight: 800;
    color: #667eea;
}
.stat-card-label {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
}

/* ==========================================
   è¼‰å…¥å‹•ç•«
   ========================================== */
.loading {
    text-align: center;
    padding: 40px;
    color: #888;
}
.loading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #e0e0e0;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
    vertical-align: middle;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* éš±è— */
.hidden { display: none !important; }

/* ==========================================
   éŸ¿æ‡‰å¼
   ========================================== */
@media (max-width: 768px) {
    body { padding: 10px; }
    .header h1 { font-size: 18px; }
    .strategy-cards { grid-template-columns: 1fr; }
    .atmosphere-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
}
</style>

</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>ğŸ¤– AIå¯è½‰å‚µç«¶æ‹ç³»çµ±</h1>
        <div class="subtitle">
            <span id="dataStatus">è¼‰å…¥ä¸­...</span>
        </div>
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" style="color:#1565c0;" id="totalCases">--</div>
                <div class="stat-label">ç«¶æ‹æ¡ˆä¾‹</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color:#2e7d32;" id="avgMultiple">--</div>
                <div class="stat-label">å¹³å‡æŠ•æ¨™å€æ•¸</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color:#7b1fa2;" id="pendingCount">--</div>
                <div class="stat-label">å¾…ç«¶æ‹</div>
            </div>
        </div>
    </div>

```
<!-- ä¸»è¦å…§å®¹ -->
<div class="main-grid">
    <!-- å·¦å´ï¼šè¼¸å…¥é¢æ¿ -->
    <div class="left-panel">
        <div class="card">
            <div class="card-header">
                <span>ğŸ“Š</span> AIç«¶æ‹åƒ¹æ ¼é æ¸¬
            </div>
            <div class="card-body">
                <!-- å¿«é€Ÿé¸å–® -->
                <div class="quick-select-section">
                    <div class="quick-select-title">âš¡ å¿«é€Ÿé¸æ“‡</div>
                    <div class="quick-select-grid" id="quickSelectGrid">
                        <span class="loading">è¼‰å…¥ä¸­</span>
                    </div>
                </div>

                <!-- è¼¸å…¥è¡¨å–® -->
                <form id="auctionForm">
                    <div class="form-group">
                        <label class="form-label">CBåç¨±/ä»£è™Ÿ</label>
                        <input type="text" class="form-control" id="cbName" placeholder="è¼¸å…¥CBåç¨±æˆ–ä»£è™Ÿ">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç†è«–åƒ¹æ ¼</label>
                            <input type="number" class="form-control" id="theoPrice" placeholder="å¦‚: 105.5" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ“”ä¿é¡å‹</label>
                            <select class="form-control" id="guarantee">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                                <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç”¢æ¥­åˆ¥</label>
                            <select class="form-control" id="industry">
                                <option value="">è«‹é¸æ“‡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¿¡ç”¨è©•ç´š(TCRI)</label>
                            <select class="form-control" id="tcri">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="1">1 (æœ€å„ª)</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9 (æœ€å·®)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç™¼è¡Œåˆ¸å•†</label>
                            <select class="form-control" id="broker">
                                <option value="">è«‹é¸æ“‡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç™¼è¡Œç¸½é¡(å„„)</label>
                            <input type="number" class="form-control" id="issueSize" placeholder="å¦‚: 10" step="0.1">
                        </div>
                    </div>

                    <div class="btn-group" style="margin-top:15px;">
                        <button type="submit" class="btn btn-primary" style="flex:1;">ğŸ”® AIé æ¸¬</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">é‡ç½®</button>
                    </div>
                </form>

                <!-- é æ¸¬çµæœ -->
                <div class="result-section hidden" id="resultSection">
                    <div class="result-header">
                        <div class="result-title">ğŸ¯ AIé æ¸¬çµæœ</div>
                        <span class="result-badge badge-success" id="confidenceBadge">ä¿¡å¿ƒåº¦: --</span>
                    </div>
                    
                    <div class="strategy-cards">
                        <div class="strategy-card conservative">
                            <div class="strategy-label" style="color:#1976d2;">ä¿å®ˆç­–ç•¥</div>
                            <div class="strategy-price" style="color:#1976d2;" id="priceConservative">--</div>
                            <div class="strategy-desc">æˆæœ¬æ§åˆ¶å„ªå…ˆ</div>
                        </div>
                        <div class="strategy-card balanced">
                            <div class="strategy-label" style="color:#7b1fa2;">ç©©å¥ç­–ç•¥</div>
                            <div class="strategy-price" style="color:#7b1fa2;" id="priceBalanced">--</div>
                            <div class="strategy-desc">å‡è¡¡è€ƒé‡</div>
                        </div>
                        <div class="strategy-card aggressive">
                            <div class="strategy-label" style="color:#c62828;">ç©æ¥µç­–ç•¥</div>
                            <div class="strategy-price" style="color:#c62828;" id="priceAggressive">--</div>
                            <div class="strategy-desc">ç¢ºä¿å¾—æ¨™</div>
                        </div>
                    </div>
                    
                    <!-- é æ¸¬æ˜ç´° -->
                    <div id="predictionDetail" style="margin-top:15px; padding:12px; background:#f8f9fa; border-radius:8px; font-size:12px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- å¸‚å ´æ°›åœ -->
        <div class="card" style="margin-top:15px;">
            <div class="card-header">
                <span>ğŸŒ¡ï¸</span> å¸‚å ´æ°›åœ
            </div>
            <div class="card-body">
                <div class="atmosphere-grid">
                    <div class="atmosphere-item">
                        <div class="atmosphere-value" id="recentMultiple">--</div>
                        <div class="atmosphere-label">è¿‘10æª”æŠ•æ¨™å€æ•¸</div>
                    </div>
                    <div class="atmosphere-item">
                        <div class="atmosphere-value" id="recentPremium">--</div>
                        <div class="atmosphere-label">è¿‘10æª”å¹³å‡æº¢åƒ¹</div>
                    </div>
                    <div class="atmosphere-item">
                        <div class="atmosphere-value" id="marketHeat">--</div>
                        <div class="atmosphere-label">å¸‚å ´ç†±åº¦</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³å´ï¼šæ­·å²æŸ¥è©¢ -->
    <div class="right-panel">
        <div class="card">
            <div class="card-header">
                <span>ğŸ“š</span> ç«¶æ‹æ­·å²è³‡æ–™åº«
            </div>
            <div class="card-body">
                <!-- æœå°‹ -->
                <div class="search-box">
                    <input type="text" class="search-input" id="historySearch" placeholder="æœå°‹CBåç¨±ã€ä»£è™Ÿã€ç”¢æ¥­...">
                    <button class="btn btn-primary" onclick="searchHistory()">æœå°‹</button>
                </div>
                
                <!-- æ¨™ç±¤é  -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('history', this)">ç«¶æ‹æ­·å²</button>
                    <button class="tab-btn" onclick="switchTab('industry', this)">ç”¢æ¥­çµ±è¨ˆ</button>
                    <button class="tab-btn" onclick="switchTab('broker', this)">åˆ¸å•†çµ±è¨ˆ</button>
                </div>
                
                <!-- ç«¶æ‹æ­·å² -->
                <div class="tab-content active" id="tabHistory">
                    <div style="max-height:500px; overflow-y:auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>CBä»£è™Ÿ</th>
                                    <th>CBåç¨±</th>
                                    <th>é–‹æ¨™æ—¥</th>
                                    <th>æ“”ä¿</th>
                                    <th>ç†è«–åƒ¹</th>
                                    <th>æœ€ä½åƒ¹</th>
                                    <th>å‡åƒ¹</th>
                                    <th>æŠ•æ¨™å€æ•¸</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr><td colspan="8" class="loading">è¼‰å…¥ä¸­</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ç”¢æ¥­çµ±è¨ˆ -->
                <div class="tab-content" id="tabIndustry">
                    <div class="stats-grid" id="industryStats">
                        <div class="loading">è¼‰å…¥ä¸­</div>
                    </div>
                </div>
                
                <!-- åˆ¸å•†çµ±è¨ˆ -->
                <div class="tab-content" id="tabBroker">
                    <div class="stats-grid" id="brokerStats">
                        <div class="loading">è¼‰å…¥ä¸­</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

</div>

<script>
// ==========================================
// å…¨åŸŸè®Šæ•¸
// ==========================================
let auctionData = [];      // ç«¶æ‹æ­·å²è³‡æ–™
let pendingData = [];      // å¾…ç™¼è¡Œè³‡æ–™
let industryMap = {};      // ç”¢æ¥­å°ç…§è¡¨
let industryStats = {};    // ç”¢æ¥­çµ±è¨ˆ
let brokerStats = {};      // åˆ¸å•†çµ±è¨ˆ

// ==========================================
// åˆå§‹åŒ–
// ==========================================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸš€ AIç«¶æ‹ç³»çµ±å•Ÿå‹•...');
    
    try {
        // è¼‰å…¥è³‡æ–™
        await loadAllData();
        
        // åˆå§‹åŒ– UI
        initializeUI();
        
        // ç¶å®šäº‹ä»¶
        bindEvents();
        
        console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
        document.getElementById('dataStatus').textContent = 'è³‡æ–™è¼‰å…¥å¤±æ•—';
    }
});

// ==========================================
// è³‡æ–™è¼‰å…¥
// ==========================================
async function loadAllData() {
    const loadCSV = async (filename) => {
        try {
            const response = await fetch(`data/00_cb/${filename}`);
            if (!response.ok) return [];
            const text = await response.text();
            return parseCSV(text);
        } catch (e) {
            console.warn(`è¼‰å…¥å¤±æ•—: ${filename}`);
            return [];
        }
    };
    
    // ä¸¦è¡Œè¼‰å…¥
    const [auction, pending, industry] = await Promise.all([
        loadCSV('04_auction.csv'),
        loadCSV('06_issue.csv'),
        loadCSV('16_industry.csv')
    ]);
    
    // è™•ç†ç«¶æ‹è³‡æ–™
    auctionData = auction.filter(row => {
        const minBid = parseFloat(row['æœ€ä½å¾—æ¨™åƒ¹æ ¼']) || parseFloat(row['æœ€ä½å¾—æ¨™åƒ¹']) || 0;
        return minBid > 0;
    }).map(row => ({
        cbCode: String(row['CBä»£è™Ÿ'] || row['å‚µåˆ¸ä»£è™Ÿ'] || '').replace('.0', ''),
        cbName: row['CBåç¨±'] || row['å‚µåˆ¸åç¨±'] || row['ç°¡ç¨±'] || '',
        date: row['é–‹æ¨™æ—¥'] || row['æˆªæ¨™æ—¥'] || '',
        guarantee: row['æ“”ä¿é¡å‹'] || row['æ“”ä¿'] || '',
        theoPrice: parseFloat(row['æˆªæ¨™æ—¥ç†è«–åƒ¹']) || parseFloat(row['ç†è«–åƒ¹æ ¼']) || 0,
        minBidPrice: parseFloat(row['æœ€ä½å¾—æ¨™åƒ¹æ ¼']) || parseFloat(row['æœ€ä½å¾—æ¨™åƒ¹']) || 0,
        avgBidPrice: parseFloat(row['å¾—æ¨™å‡åƒ¹']) || parseFloat(row['å¹³å‡å¾—æ¨™åƒ¹']) || 0,
        bidMultiple: parseFloat(row['æŠ•æ¨™å€æ•¸']) || 0,
        industry: row['ç”¢æ¥­åˆ¥'] || row['ç”¢æ¥­'] || '',
        broker: row['ç™¼è¡Œåˆ¸å•†'] || row['åˆ¸å•†'] || '',
        tcri: row['TCRI'] || row['ä¿¡è©•'] || ''
    })).sort((a, b) => {
        // ä¾æ—¥æœŸæ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
        return (b.date || '').localeCompare(a.date || '');
    });
    
    // è™•ç†å¾…ç™¼è¡Œè³‡æ–™
    pendingData = pending.filter(row => {
        const status = row['ç‹€æ…‹'] || row['ç™¼è¡Œç‹€æ…‹'] || '';
        return status.includes('ç«¶æ‹') || status.includes('å¾…');
    }).map(row => ({
        cbCode: String(row['CBä»£è™Ÿ'] || row['å‚µåˆ¸ä»£è™Ÿ'] || '').replace('.0', ''),
        cbName: row['CBåç¨±'] || row['ç°¡ç¨±'] || '',
        date: row['é–‹æ¨™æ—¥'] || row['æˆªæ¨™æ—¥'] || '',
        guarantee: row['æ“”ä¿é¡å‹'] || row['æ“”ä¿'] || '',
        theoPrice: parseFloat(row['ç†è«–åƒ¹æ ¼']) || 0,
        industry: row['ç”¢æ¥­åˆ¥'] || '',
        broker: row['ç™¼è¡Œåˆ¸å•†'] || '',
        issueSize: parseFloat(row['ç™¼è¡Œç¸½é¡']) || 0
    }));
    
    // å»ºç«‹ç”¢æ¥­å°ç…§è¡¨
    industry.forEach(row => {
        const code = String(row['è‚¡ç¥¨ä»£è™Ÿ'] || '').replace('.0', '');
        const ind = row['ç”¢æ¥­åˆ†é¡'] || '';
        if (code && ind) industryMap[code] = ind;
    });
    
    // è¨ˆç®—çµ±è¨ˆ
    calculateStats();
    
    console.log(`ğŸ“‚ è¼‰å…¥å®Œæˆ: ç«¶æ‹${auctionData.length}ç­†, å¾…ç™¼è¡Œ${pendingData.length}ç­†`);
}

// è§£æ CSV
function parseCSV(text) {
    const lines = text.split('\n').filter(l => l.trim());
    if (lines.length < 2) return [];
    
    const headers = parseCSVLine(lines[0]);
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((h, idx) => {
            row[h.trim()] = cols[idx] || '';
        });
        data.push(row);
    }
    return data;
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current);
    return result;
}

// ==========================================
// çµ±è¨ˆè¨ˆç®—
// ==========================================
function calculateStats() {
    // ç”¢æ¥­çµ±è¨ˆ
    industryStats = {};
    auctionData.forEach(d => {
        if (!d.industry) return;
        if (!industryStats[d.industry]) {
            industryStats[d.industry] = { count: 0, sumPremium: 0, sumMultiple: 0 };
        }
        const stats = industryStats[d.industry];
        stats.count++;
        if (d.theoPrice > 0 && d.minBidPrice > 0) {
            stats.sumPremium += (d.minBidPrice - d.theoPrice);
        }
        if (d.bidMultiple > 0) {
            stats.sumMultiple += d.bidMultiple;
        }
    });
    
    // åˆ¸å•†çµ±è¨ˆ
    brokerStats = {};
    auctionData.forEach(d => {
        if (!d.broker) return;
        if (!brokerStats[d.broker]) {
            brokerStats[d.broker] = { count: 0, sumPremium: 0, sumMultiple: 0 };
        }
        const stats = brokerStats[d.broker];
        stats.count++;
        if (d.theoPrice > 0 && d.minBidPrice > 0) {
            stats.sumPremium += (d.minBidPrice - d.theoPrice);
        }
        if (d.bidMultiple > 0) {
            stats.sumMultiple += d.bidMultiple;
        }
    });
}

// ==========================================
// UI åˆå§‹åŒ–
// ==========================================
function initializeUI() {
    // æ›´æ–° Header çµ±è¨ˆ
    document.getElementById('totalCases').textContent = auctionData.length;
    document.getElementById('pendingCount').textContent = pendingData.length;
    
    // å¹³å‡æŠ•æ¨™å€æ•¸
    const multiples = auctionData.map(d => d.bidMultiple).filter(v => v > 0);
    const avgMult = multiples.length > 0 ? (multiples.reduce((a,b) => a+b, 0) / multiples.length) : 0;
    document.getElementById('avgMultiple').textContent = avgMult.toFixed(2) + 'x';
    
    // æ›´æ–°è³‡æ–™ç‹€æ…‹
    document.getElementById('dataStatus').textContent = `è³‡æ–™åº« ${auctionData.length} ç­†ç«¶æ‹ç´€éŒ„`;
    
    // å¡«å……ä¸‹æ‹‰é¸å–®
    populateSelect('industry', Object.keys(industryStats).sort());
    populateSelect('broker', Object.keys(brokerStats).sort());
    
    // å¿«é€Ÿé¸å–®
    renderQuickSelect();
    
    // æ­·å²è¡¨æ ¼
    renderHistoryTable(auctionData.slice(0, 50));
    
    // å¸‚å ´æ°›åœ
    updateAtmosphere();
    
    // çµ±è¨ˆé¢æ¿
    renderIndustryStats();
    renderBrokerStats();
}

function populateSelect(id, options) {
    const select = document.getElementById(id);
    if (!select) return;
    
    // ä¿ç•™ç¬¬ä¸€å€‹é¸é …
    const firstOption = select.options[0];
    select.innerHTML = '';
    select.appendChild(firstOption);
    
    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
    });
}

// ==========================================
// å¿«é€Ÿé¸å–®
// ==========================================
function renderQuickSelect() {
    const container = document.getElementById('quickSelectGrid');
    
    // å¾…ç«¶æ‹
    let html = pendingData.slice(0, 5).map(d => 
        `<button class="quick-btn pending" onclick="loadQuickCB('${d.cbCode}', '${d.cbName}')">${d.cbName}</button>`
    ).join('');
    
    // æœ€è¿‘ç«¶æ‹
    html += auctionData.slice(0, 5).map(d => 
        `<button class="quick-btn" onclick="loadQuickCB('${d.cbCode}', '${d.cbName}')">${d.cbName}</button>`
    ).join('');
    
    container.innerHTML = html || '<span style="color:#888;">æš«ç„¡è³‡æ–™</span>';
}

function loadQuickCB(cbCode, cbName) {
    // æ‰¾åˆ°å°æ‡‰è³‡æ–™
    const auction = auctionData.find(d => d.cbCode === cbCode);
    const pending = pendingData.find(d => d.cbCode === cbCode);
    const data = auction || pending;
    
    if (data) {
        document.getElementById('cbName').value = cbName || cbCode;
        document.getElementById('theoPrice').value = data.theoPrice || '';
        document.getElementById('guarantee').value = data.guarantee || '';
        document.getElementById('industry').value = data.industry || '';
        document.getElementById('tcri').value = data.tcri || '';
        document.getElementById('broker').value = data.broker || '';
        document.getElementById('issueSize').value = data.issueSize || '';
    }
}

// ==========================================
// æ­·å²è¡¨æ ¼
// ==========================================
function renderHistoryTable(data) {
    const tbody = document.getElementById('historyTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#888;">ç„¡ç¬¦åˆè³‡æ–™</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(d => {
        const premium = d.theoPrice > 0 ? (d.minBidPrice - d.theoPrice).toFixed(2) : '-';
        const premiumClass = parseFloat(premium) >= 0 ? 'positive' : 'negative';
        
        return `
        <tr>
            <td class="cb-code" onclick="loadQuickCB('${d.cbCode}', '${d.cbName}')">${d.cbCode}</td>
            <td>${d.cbName}</td>
            <td>${d.date}</td>
            <td>${d.guarantee === 'æœ‰æ“”ä¿' ? 'âœ“' : 'âœ—'}</td>
            <td>${d.theoPrice > 0 ? d.theoPrice.toFixed(2) : '-'}</td>
            <td>${d.minBidPrice > 0 ? d.minBidPrice.toFixed(2) : '-'}</td>
            <td>${d.avgBidPrice > 0 ? d.avgBidPrice.toFixed(2) : '-'}</td>
            <td>${d.bidMultiple > 0 ? d.bidMultiple.toFixed(2) + 'x' : '-'}</td>
        </tr>`;
    }).join('');
}

function searchHistory() {
    const keyword = document.getElementById('historySearch').value.trim().toLowerCase();
    
    if (!keyword) {
        renderHistoryTable(auctionData.slice(0, 50));
        return;
    }
    
    const filtered = auctionData.filter(d => 
        (d.cbCode || '').toLowerCase().includes(keyword) ||
        (d.cbName || '').toLowerCase().includes(keyword) ||
        (d.industry || '').toLowerCase().includes(keyword) ||
        (d.broker || '').toLowerCase().includes(keyword)
    );
    
    renderHistoryTable(filtered.slice(0, 100));
}

// ==========================================
// å¸‚å ´æ°›åœ
// ==========================================
function updateAtmosphere() {
    const recent10 = auctionData.slice(0, 10);
    
    // è¿‘10æª”æŠ•æ¨™å€æ•¸
    const multiples = recent10.map(d => d.bidMultiple).filter(v => v > 0);
    const avgMult = multiples.length > 0 ? multiples.reduce((a,b) => a+b, 0) / multiples.length : 0;
    document.getElementById('recentMultiple').textContent = avgMult.toFixed(2) + 'x';
    
    // è¿‘10æª”å¹³å‡æº¢åƒ¹
    const premiums = recent10.filter(d => d.theoPrice > 0 && d.minBidPrice > 0)
        .map(d => d.minBidPrice - d.theoPrice);
    const avgPrem = premiums.length > 0 ? premiums.reduce((a,b) => a+b, 0) / premiums.length : 0;
    document.getElementById('recentPremium').textContent = avgPrem.toFixed(2) + 'å…ƒ';
    
    // å¸‚å ´ç†±åº¦åˆ¤æ–·
    let heat = 'ä¸­æ€§';
    let heatColor = '#ff9800';
    if (avgMult >= 4) {
        heat = 'ğŸ”¥ ç†±çµ¡';
        heatColor = '#c62828';
    } else if (avgMult >= 3) {
        heat = 'ğŸ“ˆ åç†±';
        heatColor = '#f57c00';
    } else if (avgMult < 2) {
        heat = 'â„ï¸ å†·æ¸…';
        heatColor = '#1976d2';
    }
    const heatEl = document.getElementById('marketHeat');
    heatEl.textContent = heat;
    heatEl.style.color = heatColor;
}

// ==========================================
// çµ±è¨ˆé¢æ¿
// ==========================================
function renderIndustryStats() {
    const container = document.getElementById('industryStats');
    const sorted = Object.entries(industryStats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);
    
    container.innerHTML = sorted.map(([name, stats]) => {
        const avgPrem = stats.count > 0 ? (stats.sumPremium / stats.count).toFixed(2) : '-';
        return `
        <div class="stat-card">
            <div class="stat-card-value">${stats.count}</div>
            <div class="stat-card-label">${name}</div>
            <div style="font-size:10px; color:#888; margin-top:4px;">å¹³å‡æº¢åƒ¹ ${avgPrem}å…ƒ</div>
        </div>`;
    }).join('');
}

function renderBrokerStats() {
    const container = document.getElementById('brokerStats');
    const sorted = Object.entries(brokerStats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);
    
    container.innerHTML = sorted.map(([name, stats]) => {
        const avgPrem = stats.count > 0 ? (stats.sumPremium / stats.count).toFixed(2) : '-';
        return `
        <div class="stat-card">
            <div class="stat-card-value">${stats.count}</div>
            <div class="stat-card-label">${name}</div>
            <div style="font-size:10px; color:#888; margin-top:4px;">å¹³å‡æº¢åƒ¹ ${avgPrem}å…ƒ</div>
        </div>`;
    }).join('');
}

// ==========================================
// æ¨™ç±¤åˆ‡æ›
// ==========================================
function switchTab(tabName, btn) {
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // åˆ‡æ›å…§å®¹
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
}

// ==========================================
// äº‹ä»¶ç¶å®š
// ==========================================
function bindEvents() {
    // è¡¨å–®æäº¤
    document.getElementById('auctionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        runPrediction();
    });
    
    // æœå°‹æ¡† Enter
    document.getElementById('historySearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchHistory();
    });
}

// ==========================================
// AI é æ¸¬æ ¸å¿ƒ
// ==========================================
function runPrediction() {
    const theoPrice = parseFloat(document.getElementById('theoPrice').value) || 0;
    const guarantee = document.getElementById('guarantee').value;
    const industry = document.getElementById('industry').value;
    const tcri = parseInt(document.getElementById('tcri').value) || 0;
    const broker = document.getElementById('broker').value;
    
    if (theoPrice <= 0) {
        alert('è«‹è¼¸å…¥ç†è«–åƒ¹æ ¼');
        return;
    }
    
    // ç·šæ€§è¿´æ­¸é æ¸¬
    const isGuaranteed = guarantee === 'æœ‰æ“”ä¿';
    let basePremium, tcriAdj = 0, industryAdj = 0;
    
    if (isGuaranteed) {
        // æœ‰æ“”ä¿ï¼šæº¢åƒ¹ = 65 - 0.56 Ã— ç†è«–åƒ¹
        basePremium = 65 - 0.56 * theoPrice;
        
        // TCRIèª¿æ•´
        const tcriMap = {4: 0, 5: -1, 6: 1, 7: -1, 8: 1, 9: -2};
        tcriAdj = tcriMap[tcri] || 0;
        
        // ç”¢æ¥­èª¿æ•´
        const highPrem = ['é‹¼éµå·¥æ¥­', 'åŠå°é«”æ¥­', 'é‹å‹•ä¼‘é–’', 'ç¶ èƒ½ç’°ä¿'];
        const lowPrem = ['é›»å­é›¶çµ„ä»¶æ¥­', 'é€šä¿¡ç¶²è·¯æ¥­', 'ç”ŸæŠ€é†«ç™‚æ¥­'];
        if (highPrem.includes(industry)) industryAdj = 2;
        if (lowPrem.includes(industry)) industryAdj = -2;
        
        basePremium = Math.max(basePremium, 0); // æœ‰æ“”ä¿æœ€ä½0
    } else {
        // ç„¡æ“”ä¿ï¼šæº¢åƒ¹ = 82 - 0.75 Ã— ç†è«–åƒ¹
        basePremium = 82 - 0.75 * theoPrice;
        
        // TCRIèª¿æ•´ï¼ˆç„¡æ“”ä¿æ•ˆæœæ›´å¤§ï¼‰
        const tcriMap = {3: 3, 4: 1, 5: 3, 6: 0, 7: -3, 8: -6};
        tcriAdj = tcriMap[tcri] || 0;
        
        // ç”¢æ¥­èª¿æ•´
        const highPrem = ['å…¶ä»–é›»å­æ¥­', 'é€šä¿¡ç¶²è·¯æ¥­', 'é‹¼éµå·¥æ¥­', 'æ±½è»Šå·¥æ¥­'];
        const lowPrem = ['å…‰é›»æ¥­', 'å»ºæç‡Ÿé€ æ¥­', 'ç”ŸæŠ€é†«ç™‚æ¥­'];
        if (highPrem.includes(industry)) industryAdj = 2;
        if (lowPrem.includes(industry)) industryAdj = -3;
    }
    
    const totalPremium = basePremium + tcriAdj + industryAdj;
    const predictedPrice = theoPrice + totalPremium;
    
    // æ¨™æº–å·®ï¼ˆç”¨æ–¼ç­–ç•¥åƒ¹æ ¼ï¼‰
    const std = isGuaranteed ? 5.5 : 6.5;
    
    // ç­–ç•¥åƒ¹æ ¼
    const conservative = Math.max(predictedPrice - 0.618 * std, theoPrice);
    const balanced = predictedPrice;
    const aggressive = predictedPrice + 0.618 * std;
    
    // æ›´æ–°é¡¯ç¤º
    document.getElementById('priceConservative').textContent = conservative.toFixed(2);
    document.getElementById('priceBalanced').textContent = balanced.toFixed(2);
    document.getElementById('priceAggressive').textContent = aggressive.toFixed(2);
    
    // ä¿¡å¿ƒåº¦
    let confidence = 70;
    if (industry) confidence += 10;
    if (tcri) confidence += 10;
    if (broker) confidence += 5;
    confidence = Math.min(confidence, 95);
    
    const badgeEl = document.getElementById('confidenceBadge');
    badgeEl.textContent = `ä¿¡å¿ƒåº¦: ${confidence}%`;
    badgeEl.className = 'result-badge ' + (confidence >= 80 ? 'badge-success' : confidence >= 60 ? 'badge-warning' : 'badge-danger');
    
    // é æ¸¬æ˜ç´°
    document.getElementById('predictionDetail').innerHTML = `
        <div style="margin-bottom:8px;"><strong>ğŸ“Š é æ¸¬ä¾æ“š</strong></div>
        <div>â€¢ æ¨¡å‹ï¼š${isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿'}ç·šæ€§è¿´æ­¸</div>
        <div>â€¢ å…¬å¼ï¼š${isGuaranteed ? '65 - 0.56Ã—ç†è«–åƒ¹' : '82 - 0.75Ã—ç†è«–åƒ¹'}</div>
        <div>â€¢ åŸºç¤æº¢åƒ¹ï¼š${basePremium.toFixed(2)}å…ƒ</div>
        <div>â€¢ TCRIèª¿æ•´ï¼š${tcriAdj >= 0 ? '+' : ''}${tcriAdj}å…ƒ</div>
        <div>â€¢ ç”¢æ¥­èª¿æ•´ï¼š${industryAdj >= 0 ? '+' : ''}${industryAdj}å…ƒ</div>
        <div style="margin-top:8px; padding-top:8px; border-top:1px dashed #ddd;">
            <strong>ç¸½æº¢åƒ¹ï¼š${totalPremium.toFixed(2)}å…ƒ</strong>
        </div>
    `;
    
    // é¡¯ç¤ºçµæœå€å¡Š
    document.getElementById('resultSection').classList.remove('hidden');
}

function resetForm() {
    document.getElementById('auctionForm').reset();
    document.getElementById('resultSection').classList.add('hidden');
}
</script>

</body>
</html>
