<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹è©•ä¼°ç³»çµ± v1.0</title>
<!-- 
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    å¯è½‰å‚µç«¶æ‹è©•ä¼°ç³»çµ± v1.0
    å¾ index_html_v3.98h æå–å·¦åŠéƒ¨ç«¶æ‹åŠŸèƒ½

```
æ ¸å¿ƒåŠŸèƒ½ï¼š
1. ç«¶æ‹æ¢ä»¶è¼¸å…¥é¢æ¿
2. AIæ™ºèƒ½è©•ä¼°æ¨¡çµ„
3. å¸‚å ´æº«åº¦è¨ˆ
4. ä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹
5. ç­–ç•¥åƒ¹æ ¼è¨ˆç®—

è³‡æ–™ä¾†æºï¼šCSV æª”æ¡ˆ (data/00_cb/ ç›®éŒ„)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

â€“>

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
/* ================= åŸºç¤è¨­å®š ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { overflow-x: hidden; max-width: 100vw; }
body { 
    font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; 
    background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);
    min-height: 100vh; 
    padding: 20px; 
}
.container { max-width: 800px; margin: 0 auto; }

/* ================= é é¦– ================= */
.header { 
    background: white; 
    border-radius: 15px; 
    padding: 25px 30px; 
    margin-bottom: 20px; 
    box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
    text-align: center; 
    border: 2px solid rgba(102, 126, 234, 0.3);
}
.header h1 { 
    color: #1a237e; 
    font-size: 26px; 
    margin-bottom: 10px; 
    font-weight: 900; 
}
.header .subtitle { 
    color: #666; 
    font-size: 14px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 10px; 
    font-weight: bold; 
    flex-wrap: wrap; 
}
.version-badge { 
    display: inline-block; 
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); 
    color: white; 
    padding: 5px 15px; 
    border-radius: 20px; 
    font-size: 12px; 
    font-weight: bold; 
    margin: 8px 0;
    box-shadow: 0 2px 8px rgba(238,90,90,0.3);
}
.header .stats-row { 
    display: flex; 
    justify-content: center; 
    gap: 30px; 
    margin-top: 15px; 
    padding-top: 15px; 
    border-top: 1px solid #e0e0e0; 
    flex-wrap: wrap;
}
.header .stat-item { text-align: center; }
.header .stat-value { font-size: 24px; font-weight: 900; color: #1a237e; }
.header .stat-label { font-size: 11px; color: #666; margin-top: 2px; }

/* ================= ä¸»é¢æ¿ ================= */
.main-panel { 
    background: white; 
    border-radius: 15px; 
    padding: 25px; 
    box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
    border-left: 6px solid #1a237e;
}
.main-panel h2 { 
    color: #1a237e; 
    font-size: 20px; 
    margin-bottom: 20px; 
    padding-bottom: 12px; 
    border-bottom: 3px solid #1a237e; 
    font-weight: 800; 
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ================= è¡¨å–®å€å¡Š ================= */
.form-section { margin-bottom: 25px; }
.form-section h3 { 
    color: #333; 
    font-size: 16px; 
    margin-bottom: 15px; 
    font-weight: bold; 
    border-left: 4px solid #1a237e; 
    padding-left: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.form-group { margin-bottom: 12px; }
.form-group label { 
    display: block; 
    color: #555; 
    font-size: 13px; 
    margin-bottom: 5px; 
    font-weight: 700; 
}
.form-group input, .form-group select { 
    width: 100%; 
    padding: 12px; 
    border: 2px solid #e0e0e0; 
    border-radius: 10px; 
    font-size: 14px; 
    transition: all 0.3s; 
    font-weight: 600; 
    color: #333;
}
.form-group input:focus, .form-group select:focus { 
    outline: none; 
    border-color: #1a237e; 
    background: #f8f9ff;
    box-shadow: 0 0 0 3px rgba(26,35,126,0.1);
}

/* ================= é–ƒé›»å¸¶å…¥ ================= */
.quick-select-section {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ffc107;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 20px;
}
.quick-select-section h4 {
    color: #e65100;
    font-size: 15px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
#quickSelect {
    width: 100%;
    font-size: 14px;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #ffc107;
    cursor: pointer;
    font-weight: 600;
}

/* ================= å€å¡Šæ¨£å¼ ================= */
.section-card {
    border-radius: 12px;
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.section-header {
    padding: 15px 18px;
    font-size: 15px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.2s;
    color: white;
}
.section-header:hover { filter: brightness(0.95); }
.section-header .toggle-icon {
    margin-left: auto;
    font-size: 12px;
    transition: transform 0.3s;
}
.section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
.section-content {
    padding: 18px;
    background: white;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    overflow: hidden;
}
.section-content.collapsed {
    max-height: 0 !important;
    padding-top: 0;
    padding-bottom: 0;
}

/* å€å¡Šä¸€ï¼šè¼¸å…¥ - è—è‰²ç³» */
.section-input .section-header {
    background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
}
/* å€å¡ŠäºŒï¼šAIè©•ä¼° - ç´«è‰²ç³» */
.section-ai .section-header {
    background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
}
/* å€å¡Šä¸‰ï¼šå¸‚å ´æº«åº¦ - ç¶ è‰²ç³» */
.section-market .section-header {
    background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
}

/* ================= çµæœå¡ç‰‡ ================= */
.result-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 15px;
    border: 2px solid #e0e0e0;
}
.result-card.highlight {
    border-color: #1a237e;
    box-shadow: 0 4px 15px rgba(26,35,126,0.2);
}
.result-title {
    font-size: 14px;
    font-weight: 700;
    color: #333;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ================= ç­–ç•¥åƒ¹æ ¼å¡ç‰‡ ================= */
.strategy-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 15px;
}
@media (max-width: 600px) {
    .strategy-grid { grid-template-columns: repeat(2, 1fr); }
}
.strategy-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    border: 2px solid #e0e0e0;
    transition: all 0.2s;
}
.strategy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.strategy-card.conservative { border-left: 4px solid #2196f3; }
.strategy-card.balanced { border-left: 4px solid #4caf50; }
.strategy-card.aggressive { border-left: 4px solid #ff9800; }
.strategy-card.ultimate { border-left: 4px solid #f44336; }
.strategy-label { font-size: 12px; color: #666; margin-bottom: 5px; }
.strategy-price { font-size: 22px; font-weight: 900; color: #333; }
.strategy-rate { font-size: 11px; color: #888; margin-top: 3px; }

/* ================= è©•ä¼°æŒ‰éˆ• ================= */
.calculate-btn {
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(26,35,126,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.calculate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(26,35,126,0.4);
}
.calculate-btn:active {
    transform: translateY(0);
}

/* ================= è­¦å‘Šæç¤º ================= */
.warning-box { 
    background: #fff3e0; 
    border-left: 4px solid #ff9800; 
    padding: 12px 15px; 
    margin-top: 10px; 
    font-size: 13px; 
    color: #e65100; 
    font-weight: 600; 
    border-radius: 0 8px 8px 0;
}

/* ================= è³‡è¨Šå¡ç‰‡ ================= */
.info-box { 
    background: #e8f5e9; 
    padding: 12px 15px; 
    border-radius: 8px; 
    border-left: 5px solid #4CAF50; 
    margin-top: 8px; 
    display: none; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
    animation: slideDown 0.3s ease-out; 
}
@keyframes slideDown { 
    from { opacity: 0; transform: translateY(-10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

/* ================= æ­·å²æœå°‹çµæœ ================= */
.history-results {
    margin-top: 10px;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #2196f3;
    border-radius: 12px;
    padding: 15px;
    display: none;
    max-height: 400px;
    overflow-y: auto;
}
.history-card {
    background: white;
    padding: 12px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid #90caf9;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}
.history-card:hover {
    border-color: #1976d2;
    box-shadow: 0 2px 8px rgba(25,118,210,0.2);
}

/* ================= çµæœé¡¯ç¤ºå€ ================= */
.result-section {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 2px solid #4caf50;
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    display: none;
}
.result-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #4caf50;
}
.result-header h3 {
    font-size: 18px;
    color: #2e7d32;
    font-weight: 800;
}

/* ================= é æ¸¬ä¿¡å¿ƒåº¦ ================= */
.confidence-bar {
    height: 10px;
    background: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
}
.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #4caf50 0%, #8bc34a 50%, #cddc39 100%);
    transition: width 0.5s;
}

/* ================= è¼‰å…¥å‹•ç•« ================= */
.loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(26,35,126,0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}
.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text {
    color: white;
    margin-top: 20px;
    font-size: 16px;
    font-weight: 600;
}

/* ================= å¸‚å ´æ°›åœé¢æ¿ ================= */
.atmosphere-panel {
    background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
    color: white;
    padding: 18px;
    border-radius: 12px;
    margin-bottom: 15px;
}
.atmosphere-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.atmosphere-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}
.atmosphere-item {
    text-align: center;
    padding: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
}
.atmosphere-item .value {
    font-size: 20px;
    font-weight: 900;
}
.atmosphere-item .label {
    font-size: 11px;
    opacity: 0.8;
    margin-top: 3px;
}

/* ================= Rexå¤§å”æé†’ ================= */
.rex-box {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ffc107;
    border-radius: 12px;
    padding: 18px;
    margin-top: 15px;
}
.rex-title {
    font-size: 15px;
    font-weight: 800;
    color: #e65100;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.rex-content {
    font-size: 14px;
    color: #5d4037;
    line-height: 1.8;
}

/* ================= é å°¾ ================= */
.footer {
    margin-top: 30px;
    padding: 20px;
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    text-align: center;
    font-size: 12px;
    color: #666;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
</style>

</head>

<body>
<!-- è¼‰å…¥å‹•ç•« -->
<div class="loading" id="loadingDiv">
    <div class="loading-spinner"></div>
    <div class="loading-text">ğŸš€ ç³»çµ±å•Ÿå‹•ä¸­...</div>
    <div style="color:rgba(255,255,255,0.7); margin-top:10px; font-size:13px;" id="loadingStatus">æ­£åœ¨è¼‰å…¥ç«¶æ‹è³‡æ–™åº«...</div>
</div>

<div class="container" style="display:none;">

<!-- é é¦– -->

<div class="header">
    <h1>ğŸ¯ AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹è©•ä¼°ç³»çµ±</h1>
    <div class="version-badge">v1.0 ç«¶æ‹å°ˆæ³¨ç‰ˆ</div>
    <div class="subtitle">
        <span>ğŸ“Š æ•¸æ“šé©…å‹•</span>
        <span>â€¢</span>
        <span>ğŸ¤– AIé æ¸¬</span>
        <span>â€¢</span>
        <span>ğŸ¯ ç²¾æº–å‡ºåƒ¹</span>
    </div>
    <div class="stats-row">
        <div class="stat-item">
            <div class="stat-value" id="totalAuction">--</div>
            <div class="stat-label">æ­·å²ç«¶æ‹æª”æ•¸</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgPremium">--</div>
            <div class="stat-label">å¹³å‡æº¢åƒ¹ç‡</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgMultiple">--</div>
            <div class="stat-label">å¹³å‡æŠ•æ¨™å€æ•¸</div>
        </div>
    </div>
</div>

<!-- ä¸»é¢æ¿ -->

<div class="main-panel">
    <h2>ğŸ“ ç«¶æ‹æ¢ä»¶è¼¸å…¥</h2>

```
<form id="evaluationForm">
    
    <!-- é–ƒé›»å¸¶å…¥ -->
    <div class="quick-select-section">
        <h4>âš¡ é–ƒé›»å¸¶å…¥ï¼ˆé¸æ“‡å¾Œè‡ªå‹•å¡«å…¥ï¼‰</h4>
        <select id="quickSelect" onchange="quickSelectCB(this.value)">
            <option value="">-- è«‹é¸æ“‡æ¡ˆä»¶ --</option>
            <optgroup label="ğŸ”¥ å³å°‡ç«¶æ‹" id="upcomingAuctionGroup"></optgroup>
            <optgroup label="âœ… è¿‘æœŸå®Œæˆç«¶æ‹" id="recentAuctionGroup"></optgroup>
        </select>
        <div id="quickSelectInfo" style="display:none; margin-top:10px; font-size:13px; color:#666;"></div>
    </div>
    
    <!-- å€å¡Šä¸€ï¼šåŸºæœ¬è³‡æ–™ -->
    <div class="section-card section-input">
        <div class="section-header" onclick="toggleSection('inputSection', this)">
            <span style="font-size:18px;">ğŸ“Œ</span>
            <span>ä¸€ã€åŸºæœ¬è³‡æ–™</span>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="section-content" id="inputSection">
            <div class="form-group">
                <label>CBåç¨± / ä»£è™Ÿ *</label>
                <input type="text" id="cbName" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨±æœå°‹æ­·å²">
                <div id="historyResults" class="history-results"></div>
            </div>
            <div class="form-group">
                <label>ç”¢æ¥­åˆ†é¡ *</label>
                <select id="industry">
                    <option value="">è«‹é¸æ“‡...</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç™¼è¡Œåˆ¸å•†</label>
                <select id="broker">
                    <option value="">è«‹é¸æ“‡...</option>
                </select>
            </div>
            <div class="form-group">
                <label>è‚¡æœ¬å€é–“</label>
                <select id="capital">
                    <option value="">è«‹é¸æ“‡...</option>
                    <option value="å°æ–¼3å„„">å°æ–¼3å„„</option>
                    <option value="3~6å„„">3~6å„„</option>
                    <option value="6~10å„„">6~10å„„</option>
                    <option value="10~15å„„">10~15å„„</option>
                    <option value="15~20å„„">15~20å„„</option>
                    <option value="å¤§æ–¼20å„„">å¤§æ–¼20å„„</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- å€å¡ŠäºŒï¼šç™¼è¡Œæ¢ä»¶ -->
    <div class="section-card section-ai">
        <div class="section-header" onclick="toggleSection('issueSection', this)">
            <span style="font-size:18px;">ğŸ’°</span>
            <span>äºŒã€ç™¼è¡Œæ¢ä»¶</span>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="section-content" id="issueSection">
            <div class="form-group">
                <label>ç™¼è¡Œè¦æ¨¡å€é–“ *</label>
                <select id="issueSize">
                    <option value="">è«‹é¸æ“‡...</option>
                    <option value="å°æ–¼2å„„">å°æ–¼2å„„</option>
                    <option value="2~5å„„">2~5å„„</option>
                    <option value="5~10å„„">5~10å„„</option>
                    <option value="10~15å„„">10~15å„„</option>
                    <option value="15~20å„„">15~20å„„</option>
                    <option value="å¤§æ–¼20å„„">å¤§æ–¼20å„„</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç™¼è¡Œå¹´æœŸ *</label>
                <select id="years">
                    <option value="">è«‹é¸æ“‡...</option>
                    <option value="3">3å¹´æœŸ</option>
                    <option value="5">5å¹´æœŸ</option>
                    <option value="7">7å¹´æœŸ</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ“”ä¿æƒ…æ³ *</label>
                <select id="guarantee">
                    <option value="">è«‹é¸æ“‡...</option>
                    <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                    <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                </select>
            </div>
            <div class="form-group">
                <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                <select id="rating">
                    <option value="">è«‹é¸æ“‡...</option>
                    <option value="1">TCRI 1</option>
                    <option value="2">TCRI 2</option>
                    <option value="3">TCRI 3</option>
                    <option value="4">TCRI 4</option>
                    <option value="5">TCRI 5</option>
                    <option value="6">TCRI 6</option>
                    <option value="7">TCRI 7</option>
                    <option value="8">TCRI 8</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- å€å¡Šä¸‰ï¼šç«¶æ‹è³‡æ–™ -->
    <div class="section-card section-market">
        <div class="section-header" onclick="toggleSection('auctionSection', this)">
            <span style="font-size:18px;">ğŸ¯</span>
            <span>ä¸‰ã€ç«¶æ‹è³‡æ–™</span>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="section-content" id="auctionSection">
            <div class="form-group">
                <label>ç«¶æ‹æˆªæ­¢æ—¥æ”¶ç›¤åƒ¹ (å…ƒ) *</label>
                <input type="number" id="stockPrice" step="0.01" placeholder="ä¾‹å¦‚ï¼š461.5">
            </div>
            <div class="form-group">
                <label>å¯¦éš›è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                <input type="number" id="conversionPrice" step="0.01" placeholder="ä¾‹å¦‚ï¼š450">
            </div>
            <div class="form-group">
                <label>åº•æ¨™åƒ¹æ ¼ (å…ƒ)</label>
                <input type="number" id="floorPrice" step="0.1" value="100" placeholder="é è¨­ï¼š100">
            </div>
            <div class="warning-box">
                âš ï¸ ç†è«–åƒ¹æ ¼éš¨è‚¡åƒ¹è®Šå‹•ï¼Œå»ºè­°æ–¼ 13:30 æˆªæ¨™å‰å†é€²è¡Œæœ€çµ‚è©¦ç®—
            </div>
        </div>
    </div>
    
    <!-- å³æ™‚ç†è«–åƒ¹è¨ˆç®— -->
    <div id="theoCalcResult" style="display:none; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border:2px solid #2196f3; border-radius:12px; padding:18px; margin-bottom:20px;">
        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px;">
            <div>
                <div style="font-size:12px; color:#1565c0; margin-bottom:5px;">ğŸ“Š è¨ˆç®—çµæœ</div>
                <div style="font-size:24px; font-weight:900; color:#0d47a1;">
                    ç†è«–åƒ¹ï¼š<span id="calcTheoPrice">--</span> å…ƒ
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px; color:#1565c0; margin-bottom:5px;">ç†è«–åƒ¹å€é–“</div>
                <div style="font-size:18px; font-weight:700; color:#1976d2;" id="calcTheoRange">--</div>
            </div>
        </div>
    </div>
    
    <!-- è©•ä¼°æŒ‰éˆ• -->
    <button type="submit" class="calculate-btn">
        <span style="font-size:24px;">ğŸ¯</span>
        <span>é–‹å§‹ AI è©•ä¼°</span>
    </button>
    
</form>

<!-- çµæœé¡¯ç¤ºå€ -->
<div class="result-section" id="resultSection">
    <div class="result-header">
        <span style="font-size:28px;">ğŸ“Š</span>
        <h3>AI æ™ºèƒ½è©•ä¼°çµæœ</h3>
    </div>
    
    <!-- ç†è«–åƒ¹èˆ‡ç­–ç•¥åƒ¹æ ¼ -->
    <div class="result-card highlight">
        <div class="result-title">ğŸ¯ ç­–ç•¥å»ºè­°åƒ¹æ ¼</div>
        <div class="strategy-grid">
            <div class="strategy-card conservative">
                <div class="strategy-label">ğŸ›¡ï¸ ä¿å®ˆ</div>
                <div class="strategy-price" id="priceConservative">--</div>
                <div class="strategy-rate" id="rateConservative">å¾—æ¨™ç‡~27%</div>
            </div>
            <div class="strategy-card balanced">
                <div class="strategy-label">âš–ï¸ ç©©å¥</div>
                <div class="strategy-price" id="priceBalanced">--</div>
                <div class="strategy-rate" id="rateBalanced">å¾—æ¨™ç‡~50%</div>
            </div>
            <div class="strategy-card aggressive">
                <div class="strategy-label">ğŸš€ ç©æ¥µ</div>
                <div class="strategy-price" id="priceAggressive">--</div>
                <div class="strategy-rate" id="rateAggressive">å¾—æ¨™ç‡~73%</div>
            </div>
            <div class="strategy-card ultimate">
                <div class="strategy-label">ğŸ”¥ æ¥µè‡´</div>
                <div class="strategy-price" id="priceUltimate">--</div>
                <div class="strategy-rate" id="rateUltimate">å¾—æ¨™ç‡~89%</div>
            </div>
        </div>
        <div style="font-size:12px; color:#666; text-align:center; margin-top:10px;">
            ç­–ç•¥åƒ¹æ ¼æ¡ç”¨é»ƒé‡‘æ¯”ä¾‹ä¿‚æ•¸ (0.618Ïƒ / 1.236Ïƒ) è¨ˆç®—
        </div>
    </div>
    
    <!-- å¸‚å ´æ°›åœ -->
    <div class="atmosphere-panel">
        <div class="atmosphere-title">ğŸŒ¡ï¸ å¸‚å ´æ°›åœåˆ†æ</div>
        <div class="atmosphere-grid">
            <div class="atmosphere-item">
                <div class="value" id="atmMultiple">--</div>
                <div class="label">é æ¸¬æŠ•æ¨™å€æ•¸</div>
            </div>
            <div class="atmosphere-item">
                <div class="value" id="atmPremium">--</div>
                <div class="label">é æ¸¬æº¢åƒ¹ç‡</div>
            </div>
            <div class="atmosphere-item">
                <div class="value" id="atmHeat">--</div>
                <div class="label">å¸‚å ´ç†±åº¦</div>
            </div>
        </div>
    </div>
    
    <!-- é æ¸¬ä¿¡å¿ƒåº¦ -->
    <div class="result-card">
        <div class="result-title">ğŸ“Š é æ¸¬ä¿¡å¿ƒåº¦</div>
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
            <span style="font-size:20px;" id="confStars">â­â­â­</span>
            <span style="font-size:16px; font-weight:700;" id="confText">ä¸­é«˜ä¿¡å¿ƒ</span>
            <span style="font-size:14px; color:#666;">(<span id="confScore">--</span>åˆ†)</span>
        </div>
        <div class="confidence-bar">
            <div class="confidence-fill" id="confBar" style="width:60%;"></div>
        </div>
        <div style="font-size:12px; color:#888; margin-top:8px;" id="confExplain">
            åŸºæ–¼æ­·å²è³‡æ–™åº«è¨ˆç®—
        </div>
    </div>
    
    <!-- Rexå¤§å”æé†’ -->
    <div class="rex-box">
        <div class="rex-title">ğŸ§¢ Rexå¤§å”æé†’</div>
        <div class="rex-content" id="rexAdvice">
            é¸æ“‡æ¢ä»¶å¾Œå°‡è‡ªå‹•ç”Ÿæˆå€‹äººåŒ–å»ºè­°...
        </div>
    </div>
</div>
```

</div>

<!-- é å°¾ -->

<div class="footer">
    <div>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹è©•ä¼°ç³»çµ± v1.0 | ç«¶æ‹å°ˆæ³¨ç‰ˆ</div>
    <div style="margin-top:8px;">ğŸ’¡ æœ¬ç³»çµ±åƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œåˆ¤æ–·</div>
    <div style="margin-top:5px; color:#999;">è³‡æ–™ä¾†æºï¼šæ­·å²ç«¶æ‹è³‡æ–™åº«</div>
</div>

</div>

<script>
// ==========================================
// å…¨åŸŸè®Šæ•¸
// ==========================================
let auctionRawData = [];  // ç«¶æ‹åŸå§‹è³‡æ–™
let cbDatabase = {};       // CBè³‡æ–™åº«
let statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} } };
let globalMarketStats = { low: 5, avg: 8 };
let pendingCases = [];     // å¾…ç«¶æ‹æ¡ˆä»¶

// ==========================================
// ç³»çµ±åˆå§‹åŒ–
// ==========================================
window.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
});

async function loadStatistics() {
    const loadingDiv = document.getElementById('loadingDiv');
    const statusDiv = document.getElementById('loadingStatus');
    
    try {
        statusDiv.textContent = 'æ­£åœ¨è¼‰å…¥ç«¶æ‹è³‡æ–™...';
        
        // å˜—è©¦è¼‰å…¥ CSV è³‡æ–™
        let auctionData = [];
        
        try {
            // å˜—è©¦å¾ data/00_cb/ è¼‰å…¥
            const response = await fetch('data/00_cb/04_auction.csv');
            if (response.ok) {
                const csvText = await response.text();
                auctionData = parseCSV(csvText);
                console.log('å¾CSVè¼‰å…¥ç«¶æ‹è³‡æ–™:', auctionData.length, 'ç­†');
            }
        } catch (e) {
            console.log('CSVè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨ç¤ºç¯„è³‡æ–™');
        }
        
        // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨ç¤ºç¯„è³‡æ–™
        if (auctionData.length === 0) {
            auctionData = generateSampleData();
        }
        
        // è™•ç†è³‡æ–™
        statusDiv.textContent = 'æ­£åœ¨è™•ç†è³‡æ–™...';
        processAuctionData(auctionData);
        
        // åˆå§‹åŒ–UI
        statusDiv.textContent = 'åˆå§‹åŒ–ä»‹é¢...';
        initializeUI();
        
        // å®Œæˆ
        loadingDiv.style.display = 'none';
        document.querySelector('.container').style.display = 'block';
        
    } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        loadingDiv.innerHTML = `
            <div style="padding:20px; background:white; color:#D32F2F; border-radius:10px; text-align:center; max-width:400px;">
                <h3>âš ï¸ ç³»çµ±å•Ÿå‹•å¤±æ•—</h3>
                <p style="margin:10px 0;">${error.message}</p>
                <button onclick="location.reload()" style="padding:10px 20px; cursor:pointer; border:none; background:#1a237e; color:white; border-radius:8px;">é‡è©¦</button>
            </div>`;
    }
}

// è§£æCSV
function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const row = {};
        headers.forEach((h, idx) => {
            row[h] = (values[idx] || '').trim().replace(/"/g, '');
        });
        data.push(row);
    }
    
    return data;
}

// ç”Ÿæˆç¤ºç¯„è³‡æ–™
function generateSampleData() {
    const industries = ['åŠå°é«”', 'é›»å­é›¶çµ„ä»¶', 'å…‰é›»', 'é€šè¨Šç¶²è·¯', 'é›»è…¦åŠé€±é‚Š', 'ç”ŸæŠ€é†«ç™‚', 'é‡‘è', 'å‚³ç”¢', 'å…¶ä»–'];
    const brokers = ['å…ƒå¤§', 'å‡±åŸº', 'å¯Œé‚¦', 'æ°¸è±é‡‘', 'ä¸­ä¿¡', 'åœ‹æ³°', 'å°æ–°', 'ç‰å±±', 'å…†è±'];
    const data = [];
    
    for (let i = 0; i < 300; i++) {
        const year = 2019 + Math.floor(i / 50);
        const theoPrice = 85 + Math.random() * 40;
        const premium = 3 + Math.random() * 15;
        const minBid = theoPrice * (1 + premium / 100);
        const avgBid = minBid * (1 + Math.random() * 0.03);
        
        data.push({
            'CBä»£è™Ÿ': `${1000 + i}`,
            'åç¨±': `ç¤ºç¯„CB${i + 1}`,
            'é–‹æ¨™æ—¥æœŸ': `${year}/${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}/${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
            'ç”¢æ¥­åˆ†é¡': industries[Math.floor(Math.random() * industries.length)],
            'ç™¼è¡Œåˆ¸å•†': brokers[Math.floor(Math.random() * brokers.length)],
            'æ“”ä¿': Math.random() > 0.7 ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿',
            'ä¿¡ç”¨è©•ç­‰': String(Math.floor(Math.random() * 6) + 2),
            'è‚¡æœ¬': (Math.random() * 30 + 2).toFixed(1),
            'ç™¼è¡Œè¦æ¨¡': (Math.random() * 20 + 1).toFixed(1),
            'å¹´æœŸ': [3, 5, 7][Math.floor(Math.random() * 3)],
            'è½‰æ›åƒ¹æ ¼': (Math.random() * 200 + 20).toFixed(2),
            'æˆªæ¨™æ—¥æ”¶ç›¤åƒ¹': (Math.random() * 300 + 50).toFixed(2),
            'ç†è«–åƒ¹': theoPrice.toFixed(2),
            'åº•æ¨™åƒ¹æ ¼': '100',
            'æœ€ä½å¾—æ¨™': minBid.toFixed(2),
            'å¹³å‡å¾—æ¨™': avgBid.toFixed(2),
            'æœ€ä½æº¢åƒ¹ç‡': premium.toFixed(2),
            'å¹³å‡æº¢åƒ¹ç‡': (premium + 1 + Math.random() * 2).toFixed(2),
            'æŠ•æ¨™å€æ•¸': (2 + Math.random() * 4).toFixed(2),
            'æ›ç‰Œæœ€é«˜': (minBid * (1 + Math.random() * 0.5)).toFixed(2),
            'æ›ç‰Œæœ€ä½': (minBid * (0.95 + Math.random() * 0.1)).toFixed(2)
        });
    }
    
    return data;
}

// è™•ç†ç«¶æ‹è³‡æ–™
function processAuctionData(data) {
    const safeFloat = (v) => {
        if (typeof v === 'number') return v;
        const n = parseFloat(String(v).replace(/[,%]/g, ''));
        return isNaN(n) ? 0 : n;
    };
    
    auctionRawData = data.map(row => {
        const item = {
            id: row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '',
            name: row['åç¨±'] || row['CBåç¨±'] || '',
            openDate: row['é–‹æ¨™æ—¥æœŸ'] || row['æˆªæ¨™æ—¥'] || '',
            industry: row['ç”¢æ¥­åˆ†é¡'] || row['ç”¢æ¥­'] || '',
            broker: row['ç™¼è¡Œåˆ¸å•†'] || row['åˆ¸å•†'] || '',
            guarantee: row['æ“”ä¿'] || row['æ“”ä¿é¡å‹'] || 'ç„¡æ“”ä¿',
            rating: row['ä¿¡ç”¨è©•ç­‰'] || row['ä¿¡è©•'] || row['TCRI'] || '',
            capital: safeFloat(row['è‚¡æœ¬']),
            issueSize: safeFloat(row['ç™¼è¡Œè¦æ¨¡']),
            years: safeFloat(row['å¹´æœŸ']),
            conversionPrice: safeFloat(row['è½‰æ›åƒ¹æ ¼'] || row['è½‰æ›åƒ¹']),
            closePrice: safeFloat(row['æˆªæ¨™æ—¥æ”¶ç›¤åƒ¹'] || row['æ”¶ç›¤åƒ¹']),
            theoreticalPrice: safeFloat(row['ç†è«–åƒ¹']),
            floorPrice: safeFloat(row['åº•æ¨™åƒ¹æ ¼'] || row['åº•æ¨™']) || 100,
            minBidPrice: safeFloat(row['æœ€ä½å¾—æ¨™'] || row['æœ€ä½å¾—æ¨™åƒ¹']),
            avgBidPrice: safeFloat(row['å¹³å‡å¾—æ¨™'] || row['å¹³å‡å¾—æ¨™åƒ¹']),
            lowPremium: safeFloat(row['æœ€ä½æº¢åƒ¹ç‡'] || row['æœ€ä½æº¢åƒ¹']),
            avgPremium: safeFloat(row['å¹³å‡æº¢åƒ¹ç‡'] || row['å¹³å‡æº¢åƒ¹']),
            bidMultiple: safeFloat(row['æŠ•æ¨™å€æ•¸']),
            marketHigh: safeFloat(row['æ›ç‰Œæœ€é«˜']),
            marketLow: safeFloat(row['æ›ç‰Œæœ€ä½'])
        };
        
        // å»ºç«‹è³‡æ–™åº«
        if (item.name) {
            cbDatabase[item.name] = item;
        }
        
        return item;
    }).filter(item => item.name && item.minBidPrice > 0);
    
    // è¨ˆç®—çµ±è¨ˆ
    calculateStatistics();
    
    console.log('è™•ç†å®Œæˆï¼Œæœ‰æ•ˆè³‡æ–™:', auctionRawData.length, 'ç­†');
}

// è¨ˆç®—çµ±è¨ˆè³‡æ–™
function calculateStatistics() {
    // ç”¢æ¥­çµ±è¨ˆ
    const industryMap = {};
    const brokerMap = {};
    
    auctionRawData.forEach(d => {
        if (d.industry) {
            if (!industryMap[d.industry]) {
                industryMap[d.industry] = { count: 0, sumPremium: 0, sumMult: 0 };
            }
            industryMap[d.industry].count++;
            industryMap[d.industry].sumPremium += d.lowPremium;
            industryMap[d.industry].sumMult += d.bidMultiple;
        }
        
        if (d.broker) {
            if (!brokerMap[d.broker]) {
                brokerMap[d.broker] = { count: 0, sumPremium: 0 };
            }
            brokerMap[d.broker].count++;
            brokerMap[d.broker].sumPremium += d.lowPremium;
        }
    });
    
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'] = industryMap;
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'] = brokerMap;
    
    // å…¨åŸŸçµ±è¨ˆ
    let sumLow = 0, sumMult = 0, count = 0;
    auctionRawData.forEach(d => {
        if (d.minBidPrice > 0) {
            sumLow += d.lowPremium;
            sumMult += d.bidMultiple;
            count++;
        }
    });
    
    if (count > 0) {
        globalMarketStats.low = sumLow / count;
        globalMarketStats.avg = sumMult / count;
    }
}

// åˆå§‹åŒ–UI
function initializeUI() {
    // æ›´æ–°çµ±è¨ˆæ•¸æ“š
    document.getElementById('totalAuction').textContent = auctionRawData.length;
    document.getElementById('avgPremium').textContent = globalMarketStats.low.toFixed(1) + '%';
    document.getElementById('avgMultiple').textContent = globalMarketStats.avg.toFixed(2) + 'x';
    
    // å¡«å……ç”¢æ¥­ä¸‹æ‹‰é¸å–®
    const industrySelect = document.getElementById('industry');
    const industries = Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']).sort((a, b) => {
        return statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'][b].count - statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'][a].count;
    });
    industries.forEach(ind => {
        const opt = document.createElement('option');
        opt.value = ind;
        opt.textContent = `${ind} (${statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'][ind].count}æª”)`;
        industrySelect.appendChild(opt);
    });
    
    // å¡«å……åˆ¸å•†ä¸‹æ‹‰é¸å–®
    const brokerSelect = document.getElementById('broker');
    const brokers = Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']).sort((a, b) => {
        return statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'][b].count - statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'][a].count;
    });
    brokers.forEach(brk => {
        const opt = document.createElement('option');
        opt.value = brk;
        opt.textContent = `${brk} (${statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'][brk].count}æª”)`;
        brokerSelect.appendChild(opt);
    });
    
    // å¡«å……é–ƒé›»å¸¶å…¥
    initQuickSelect();
    
    // ç¶å®šäº‹ä»¶
    bindEvents();
}

// åˆå§‹åŒ–é–ƒé›»å¸¶å…¥
function initQuickSelect() {
    const recentGroup = document.getElementById('recentAuctionGroup');
    
    // å–æœ€è¿‘20ç­†
    const recent = [...auctionRawData]
        .sort((a, b) => new Date(b.openDate) - new Date(a.openDate))
        .slice(0, 20);
    
    recent.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.name;
        opt.textContent = `${d.name} | ${d.openDate} | ${d.industry}`;
        recentGroup.appendChild(opt);
    });
}

// é–ƒé›»å¸¶å…¥é¸æ“‡
function quickSelectCB(name) {
    if (!name) return;
    
    const cb = cbDatabase[name];
    if (!cb) return;
    
    // å¡«å…¥è¡¨å–®
    document.getElementById('cbName').value = name;
    document.getElementById('industry').value = cb.industry || '';
    document.getElementById('broker').value = cb.broker || '';
    document.getElementById('guarantee').value = cb.guarantee || '';
    document.getElementById('rating').value = cb.rating || '';
    document.getElementById('stockPrice').value = cb.closePrice || '';
    document.getElementById('conversionPrice').value = cb.conversionPrice || '';
    
    // ç™¼è¡Œè¦æ¨¡å€é–“
    const size = cb.issueSize;
    let sizeRange = '';
    if (size < 2) sizeRange = 'å°æ–¼2å„„';
    else if (size < 5) sizeRange = '2~5å„„';
    else if (size < 10) sizeRange = '5~10å„„';
    else if (size < 15) sizeRange = '10~15å„„';
    else if (size < 20) sizeRange = '15~20å„„';
    else sizeRange = 'å¤§æ–¼20å„„';
    document.getElementById('issueSize').value = sizeRange;
    
    document.getElementById('years').value = cb.years || '';
    
    // é¡¯ç¤ºè³‡è¨Š
    const info = document.getElementById('quickSelectInfo');
    info.style.display = 'block';
    info.innerHTML = `
        âœ… å·²å¸¶å…¥ã€Œ${name}ã€è³‡æ–™<br>
        ğŸ“Š æ­·å²æœ€ä½å¾—æ¨™ï¼š${cb.minBidPrice.toFixed(2)} å…ƒ | æº¢åƒ¹ç‡ï¼š${cb.lowPremium.toFixed(2)}%
    `;
    
    // è§¸ç™¼ç†è«–åƒ¹è¨ˆç®—
    updateTheoPrice();
}

// ç¶å®šäº‹ä»¶
function bindEvents() {
    // CBåç¨±æœå°‹
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();
        const histDiv = document.getElementById('historyResults');
        
        if (val.length >= 2) {
            const matches = auctionRawData.filter(d => {
                return (d.id && d.id.includes(val)) || (d.name && d.name.includes(val));
            }).slice(0, 10);
            
            if (matches.length > 0) {
                let html = '';
                matches.forEach(d => {
                    html += `
                        <div class="history-card" onclick="selectHistoryCB('${d.name}')">
                            <div style="font-weight:700; color:#1565c0;">${d.name}</div>
                            <div style="font-size:12px; color:#666; margin-top:5px;">
                                ${d.openDate} | ${d.industry} | 
                                æœ€ä½å¾—æ¨™: ${d.minBidPrice.toFixed(2)}å…ƒ | 
                                æº¢åƒ¹: ${d.lowPremium.toFixed(2)}%
                            </div>
                        </div>
                    `;
                });
                histDiv.innerHTML = html;
                histDiv.style.display = 'block';
            } else {
                histDiv.style.display = 'none';
            }
        } else {
            histDiv.style.display = 'none';
        }
    });
    
    // è‚¡åƒ¹/è½‰æ›åƒ¹è¼¸å…¥æ™‚æ›´æ–°ç†è«–åƒ¹
    document.getElementById('stockPrice').addEventListener('input', updateTheoPrice);
    document.getElementById('conversionPrice').addEventListener('input', updateTheoPrice);
    
    // è¡¨å–®æäº¤
    document.getElementById('evaluationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        calculateEvaluation();
    });
}

// é¸æ“‡æ­·å²CB
function selectHistoryCB(name) {
    document.getElementById('quickSelect').value = name;
    quickSelectCB(name);
    document.getElementById('historyResults').style.display = 'none';
}

// æ›´æ–°ç†è«–åƒ¹è¨ˆç®—
function updateTheoPrice() {
    const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 0;
    const convPrice = parseFloat(document.getElementById('conversionPrice').value) || 0;
    
    const resultDiv = document.getElementById('theoCalcResult');
    
    if (stockPrice > 0 && convPrice > 0) {
        const theo = (stockPrice / convPrice) * 100;
        document.getElementById('calcTheoPrice').textContent = theo.toFixed(2);
        
        // åˆ¤æ–·å€é–“
        let range = '';
        if (theo < 90) range = 'å°æ–¼90å…ƒ';
        else if (theo < 95) range = '90~95å…ƒ';
        else if (theo < 100) range = '95~100å…ƒ';
        else if (theo < 105) range = '100~105å…ƒ';
        else if (theo < 110) range = '105~110å…ƒ';
        else if (theo < 115) range = '110~115å…ƒ';
        else range = 'å¤§æ–¼115å…ƒ';
        
        document.getElementById('calcTheoRange').textContent = range;
        resultDiv.style.display = 'block';
    } else {
        resultDiv.style.display = 'none';
    }
}

// å€å¡Šå±•é–‹/æ”¶åˆ
function toggleSection(sectionId, headerEl) {
    const content = document.getElementById(sectionId);
    const isCollapsed = content.classList.contains('collapsed');
    
    if (isCollapsed) {
        content.classList.remove('collapsed');
        headerEl.classList.remove('collapsed');
    } else {
        content.classList.add('collapsed');
        headerEl.classList.add('collapsed');
    }
}

// ==========================================
// æ ¸å¿ƒè©•ä¼°è¨ˆç®—
// ==========================================
function calculateEvaluation() {
    // æ”¶é›†è¡¨å–®è³‡æ–™
    const stockPrice = parseFloat(document.getElementById('stockPrice').value) || 0;
    const convPrice = parseFloat(document.getElementById('conversionPrice').value) || 0;
    const floorPrice = parseFloat(document.getElementById('floorPrice').value) || 100;
    const guarantee = document.getElementById('guarantee').value;
    const rating = document.getElementById('rating').value;
    const industry = document.getElementById('industry').value;
    const issueSize = document.getElementById('issueSize').value;
    
    // é©—è­‰å¿…å¡«
    if (stockPrice <= 0 || convPrice <= 0) {
        alert('è«‹å¡«å¯«è‚¡åƒ¹å’Œè½‰æ›åƒ¹ï¼');
        return;
    }
    
    // è¨ˆç®—ç†è«–åƒ¹
    const theo = (stockPrice / convPrice) * 100;
    
    // ç¯©é¸ç›¸ä¼¼æ¢ä»¶çš„æ­·å²è³‡æ–™
    const isGuaranteed = guarantee === 'æœ‰æ“”ä¿';
    
    // å–å¾—åŒå€é–“+åŒæ“”ä¿çš„è³‡æ–™
    const getSegment = (t) => {
        if (t < 90) return '<90';
        if (t < 95) return '90-95';
        if (t < 100) return '95-100';
        if (t < 105) return '100-105';
        if (t < 110) return '105-110';
        if (t < 115) return '110-115';
        return '>=115';
    };
    
    const targetSegment = getSegment(theo);
    
    const filtered = auctionRawData.filter(d => {
        const dTheo = d.theoreticalPrice || 0;
        const dGuaranteed = d.guarantee === 'æœ‰æ“”ä¿' || d.guarantee === 'æœ‰';
        
        if (d.minBidPrice <= 0 || dTheo <= 0) return false;
        if (dGuaranteed !== isGuaranteed) return false;
        
        // å…è¨±ç›¸é„°å€é–“
        const segments = ['<90', '90-95', '95-100', '100-105', '105-110', '110-115', '>=115'];
        const targetIdx = segments.indexOf(targetSegment);
        const dIdx = segments.indexOf(getSegment(dTheo));
        return Math.abs(targetIdx - dIdx) <= 1;
    }).sort((a, b) => new Date(b.openDate) - new Date(a.openDate));
    
    console.log('ç¯©é¸åˆ°ç›¸ä¼¼æ¡ˆä¾‹:', filtered.length, 'ç­†');
    
    // è¨ˆç®—çµ±è¨ˆ
    let avgPremium = globalMarketStats.low;
    let stdPremium = 3;
    let avgMult = globalMarketStats.avg;
    let sampleCount = filtered.length;
    
    if (filtered.length >= 3) {
        const premiums = filtered.map(d => d.lowPremium);
        avgPremium = premiums.reduce((a, b) => a + b, 0) / premiums.length;
        stdPremium = Math.sqrt(premiums.reduce((s, p) => s + Math.pow(p - avgPremium, 2), 0) / premiums.length);
        
        const mults = filtered.map(d => d.bidMultiple).filter(m => m > 0);
        if (mults.length > 0) {
            avgMult = mults.reduce((a, b) => a + b, 0) / mults.length;
        }
    }
    
    // v3.98g ç·šæ€§é æ¸¬æ¨¡å‹
    let linearPremium = avgPremium;
    if (isGuaranteed) {
        // æœ‰æ“”ä¿ï¼šæº¢åƒ¹ = 65 - 0.56 Ã— ç†è«–åƒ¹ + TCRIèª¿æ•´
        linearPremium = 65 - 0.56 * theo;
        if (rating) {
            const tcriAdj = { '1': -2, '2': -1.5, '3': -1, '4': -0.5, '5': 0, '6': 0.5, '7': 1, '8': 2 };
            linearPremium += (tcriAdj[rating] || 0);
        }
    } else {
        // ç„¡æ“”ä¿ï¼šæº¢åƒ¹ = 82 - 0.75 Ã— ç†è«–åƒ¹ + TCRIèª¿æ•´
        linearPremium = 82 - 0.75 * theo;
        if (rating) {
            const tcriAdj = { '1': -6, '2': -4, '3': -2, '4': -1, '5': 0, '6': 1, '7': 3, '8': 6 };
            linearPremium += (tcriAdj[rating] || 0);
        }
    }
    
    // æ•´åˆé æ¸¬ï¼ˆæ­·å²çµ±è¨ˆ + ç·šæ€§æ¨¡å‹ï¼‰
    const finalPremium = filtered.length >= 5 ? 
        avgPremium * 0.6 + linearPremium * 0.4 : 
        linearPremium;
    
    // è¨ˆç®—ç­–ç•¥åƒ¹æ ¼
    // ä¿å®ˆ = Î¼ - 0.618Ïƒ
    // ç©©å¥ = Î¼
    // ç©æ¥µ = Î¼ + 0.618Ïƒ
    // æ¥µè‡´ = Î¼ + 1.236Ïƒ
    const conservative = Math.max(floorPrice, theo * (1 + (finalPremium - 0.618 * stdPremium) / 100));
    const balanced = Math.max(floorPrice, theo * (1 + finalPremium / 100));
    const aggressive = Math.max(floorPrice, theo * (1 + (finalPremium + 0.618 * stdPremium) / 100));
    const ultimate = Math.min(theo * (1 + (avgPremium + 2 * stdPremium) / 100), 
                              theo * (1 + (finalPremium + 1.236 * stdPremium) / 100));
    
    // ä¿¡å¿ƒåº¦è¨ˆç®—
    let confScore = 50;
    if (sampleCount >= 15) confScore += 30;
    else if (sampleCount >= 10) confScore += 20;
    else if (sampleCount >= 5) confScore += 10;
    
    if (stdPremium < 3) confScore += 15;
    else if (stdPremium < 5) confScore += 10;
    
    confScore = Math.min(100, Math.max(0, confScore));
    
    // æ›´æ–°UI
    document.getElementById('priceConservative').textContent = conservative.toFixed(2);
    document.getElementById('priceBalanced').textContent = balanced.toFixed(2);
    document.getElementById('priceAggressive').textContent = aggressive.toFixed(2);
    document.getElementById('priceUltimate').textContent = ultimate.toFixed(2);
    
    document.getElementById('atmMultiple').textContent = avgMult.toFixed(2) + 'x';
    document.getElementById('atmPremium').textContent = finalPremium.toFixed(1) + '%';
    
    // ç†±åº¦åˆ¤æ–·
    let heatText = 'é©ä¸­';
    let heatColor = '#4caf50';
    if (avgMult >= 4) { heatText = 'ğŸ”¥ é«˜ç†±'; heatColor = '#f44336'; }
    else if (avgMult >= 3) { heatText = 'â¬†ï¸ åç†±'; heatColor = '#ff9800'; }
    else if (avgMult < 2) { heatText = 'â¬‡ï¸ åå†·'; heatColor = '#2196f3'; }
    document.getElementById('atmHeat').textContent = heatText;
    document.getElementById('atmHeat').style.color = heatColor;
    
    // ä¿¡å¿ƒåº¦
    let stars = 'â­';
    let confText = 'ä½ä¿¡å¿ƒ';
    if (confScore >= 80) { stars = 'â­â­â­â­'; confText = 'é«˜ä¿¡å¿ƒ'; }
    else if (confScore >= 60) { stars = 'â­â­â­'; confText = 'ä¸­é«˜ä¿¡å¿ƒ'; }
    else if (confScore >= 40) { stars = 'â­â­'; confText = 'ä¸­ä¿¡å¿ƒ'; }
    
    document.getElementById('confStars').textContent = stars;
    document.getElementById('confText').textContent = confText;
    document.getElementById('confScore').textContent = confScore;
    document.getElementById('confBar').style.width = confScore + '%';
    document.getElementById('confExplain').textContent = 
        `åŸºæ–¼ ${sampleCount} ç­†ç›¸ä¼¼æ¡ˆä¾‹è¨ˆç®—ï¼Œæ¨™æº–å·® ${stdPremium.toFixed(2)}%`;
    
    // Rexå¤§å”å»ºè­°
    let advice = '';
    if (theo < 95) {
        advice = `
            <p><b>ğŸ’¡ ä½ç†è«–åƒ¹æƒ…å¢ƒ (${theo.toFixed(2)}å…ƒ)</b></p>
            <p>ç†è«–åƒ¹åä½ï¼Œå»ºè­°ä»¥ã€Œå¾—æ¨™åƒ¹æ ¼ã€ç‚ºä¸»è¦åƒè€ƒï¼Œè€Œéæº¢åƒ¹ç‡ã€‚</p>
            <p>ä¿å®ˆç­–ç•¥ ${conservative.toFixed(2)} å…ƒæ˜¯è¼ƒå®‰å…¨çš„é¸æ“‡ï¼Œèƒ½æœ‰æ•ˆæ§åˆ¶é¢¨éšªã€‚</p>
        `;
    } else if (theo <= 105) {
        advice = `
            <p><b>âœ¨ ç†æƒ³å€é–“ (${theo.toFixed(2)}å…ƒ)</b></p>
            <p>ç†è«–åƒ¹è™•æ–¼ 95-105 å…ƒçš„ç†æƒ³å€é–“ï¼Œæ­·å²è³‡æ–™åƒè€ƒåƒ¹å€¼é«˜ã€‚</p>
            <p>å»ºè­°æ¡ç”¨ç©©å¥ç­–ç•¥ ${balanced.toFixed(2)} å…ƒï¼Œå…¼é¡§å¾—æ¨™ç‡èˆ‡æˆæœ¬æ§åˆ¶ã€‚</p>
        `;
    } else {
        advice = `
            <p><b>âš¡ é«˜ç†è«–åƒ¹è­¦ç¤º (${theo.toFixed(2)}å…ƒ)</b></p>
            <p>ç†è«–åƒ¹åé«˜ï¼ŒæŠ•æ¨™åƒ¹æ ¼ä¹Ÿæœƒç›¸å°è¼ƒé«˜ï¼Œé¢¨éšªéœ€è¬¹æ…è©•ä¼°ã€‚</p>
            <p>å»ºè­°æ¡ç”¨ä¿å®ˆç­–ç•¥ ${conservative.toFixed(2)} å…ƒï¼Œåš´æ§æŠ•æ¨™æˆæœ¬ã€‚</p>
        `;
    }
    
    advice += `
        <hr style="margin:12px 0; border:none; border-top:1px dashed #ccc;">
        <p style="font-style:italic; color:#795548;">
            ğŸ’¬ ç«¶æ‹çš„æ ¸å¿ƒæ˜¯æ§åˆ¶æˆæœ¬ï¼Œä¸æ˜¯æ¶ç±Œç¢¼ã€‚é¸æ“‡é©åˆè‡ªå·±é¢¨éšªæ‰¿å—åº¦çš„ç­–ç•¥ï¼Œè®“è‡ªå·±ç«‹æ–¼ä¸æ•—ä¹‹åœ°ã€‚
        </p>
    `;
    
    document.getElementById('rexAdvice').innerHTML = advice;
    
    // é¡¯ç¤ºçµæœå€
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
}
</script>

</body>
</html>
