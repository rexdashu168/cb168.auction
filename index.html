<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIå¯è½‰å‚µç«¶æ‹ç³»çµ± v2.0</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
.header { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
.header h1 { color: #667eea; font-size: 26px; margin-bottom: 8px; }
.header .stats-row { display: flex; justify-content: center; gap: 30px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0; }
.header .stat-item { text-align: center; }
.header .stat-value { font-size: 24px; font-weight: 900; }
.header .stat-label { font-size: 11px; color: #666; }

.main-grid { display: grid; grid-template-columns: 420px 1fr; gap: 20px; }
@media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

.panel { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
.panel h2 { color: #667eea; font-size: 16px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; display: flex; align-items: center; gap: 8px; }
.form-section { margin-bottom: 20px; }
.form-section h3 { color: #333; font-size: 14px; margin-bottom: 12px; border-left: 4px solid #667eea; padding-left: 10px; }
.form-group { margin-bottom: 12px; }
.form-group label { display: block; color: #555; font-size: 12px; margin-bottom: 4px; font-weight: 600; }
.form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }

.btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
.btn-reset { background: #f5f5f5; color: #666; }

.result-card { background: linear-gradient(135deg, #f8f9ff 0%, #e8ebff 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
.result-title { font-size: 16px; font-weight: bold; color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.price-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.price-item { background: white; padding: 15px; border-radius: 10px; text-align: center; }
.price-item.conservative { border-left: 4px solid #4caf50; }
.price-item.balanced { border-left: 4px solid #2196f3; }
.price-item.aggressive { border-left: 4px solid #ff9800; }
.price-label { font-size: 12px; color: #666; margin-bottom: 5px; }
.price-value { font-size: 22px; font-weight: bold; }
.price-item.conservative .price-value { color: #4caf50; }
.price-item.balanced .price-value { color: #2196f3; }
.price-item.aggressive .price-value { color: #ff9800; }

.info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e0e0e0; font-size: 13px; }
.info-row:last-child { border-bottom: none; }
.info-label { color: #666; }
.info-value { font-weight: 600; color: #333; }

.quick-select { background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
.quick-select h3 { color: #f57c00; margin-bottom: 10px; font-size: 14px; }
.quick-select select { border: 2px solid #ffc107; font-weight: bold; }

.atmosphere-card { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
.atmosphere-title { font-size: 14px; font-weight: bold; color: #2e7d32; margin-bottom: 10px; }
.atmosphere-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.atmosphere-item { background: white; padding: 10px; border-radius: 8px; text-align: center; }
.atmosphere-value { font-size: 18px; font-weight: bold; color: #2e7d32; }
.atmosphere-label { font-size: 11px; color: #666; }

.history-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
.history-table th { background: #667eea; color: white; padding: 10px; text-align: left; }
.history-table td { padding: 8px 10px; border-bottom: 1px solid #e0e0e0; }
.history-table tr:hover { background: #f5f5f5; }

.loading { text-align: center; padding: 40px; color: #666; }
.loading-spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

</head>
<body>
<div class="container">
<!-- Header -->
<div class="header">
    <h1>ğŸ¤– AIå¯è½‰å‚µç«¶æ‹ç³»çµ±</h1>
    <div style="color:#666; font-size:13px;">åŸºæ–¼307æª”æ­·å²æ•¸æ“šçš„æ™ºèƒ½é æ¸¬ç³»çµ± v2.0</div>
    <div class="stats-row">
        <div class="stat-item">
            <div class="stat-value" id="totalCases" style="color:#667eea;">--</div>
            <div class="stat-label">ç«¶æ‹æ¡ˆä¾‹</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgMultiplier" style="color:#ff9800;">--</div>
            <div class="stat-label">å¹³å‡æŠ•æ¨™å€æ•¸</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="pendingCount" style="color:#4caf50;">--</div>
            <div class="stat-label">å¾…ç«¶æ‹</div>
        </div>
    </div>
</div>

<!-- ä¸»é«” Grid -->

<div class="main-grid">
    <!-- å·¦å´ï¼šè¼¸å…¥é¢æ¿ -->
    <div class="panel" style="max-height: calc(100vh - 180px); overflow-y: auto;">
        <h2>ğŸ“‹ ç«¶æ‹æ¢ä»¶è¼¸å…¥</h2>

```
    <!-- é–ƒé›»å¸¶å…¥ -->
    <div class="quick-select">
        <h3>âš¡ é–ƒé›»å¸¶å…¥</h3>
        <div class="form-group">
            <select id="quickSelect">
                <option value="">-- é¸æ“‡æ¡ˆä»¶è‡ªå‹•å¸¶å…¥ --</option>
            </select>
        </div>
    </div>
    
    <form id="evalForm">
        <!-- åŸºæœ¬è³‡æ–™ -->
        <div class="form-section">
            <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
            <div class="form-group">
                <label>CBåç¨±/ä»£è™Ÿ</label>
                <input type="text" id="cbName" placeholder="å¦‚ï¼šç²¾æ¸¬ä¸€">
            </div>
            <div class="form-group">
                <label>ç”¢æ¥­åˆ†é¡ *</label>
                <select id="industry"><option value="">è«‹é¸æ“‡...</option></select>
            </div>
            <div class="form-group">
                <label>ç™¼è¡Œåˆ¸å•†</label>
                <select id="broker"><option value="">è«‹é¸æ“‡...</option></select>
            </div>
        </div>
        
        <!-- ç™¼è¡Œæ¢ä»¶ -->
        <div class="form-section">
            <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
            <div class="form-group">
                <label>æ“”ä¿æƒ…æ³ *</label>
                <select id="guarantee">
                    <option value="">è«‹é¸æ“‡...</option>
                    <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                    <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                </select>
            </div>
            <div class="form-group">
                <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                <select id="rating">
                    <option value="">è«‹é¸æ“‡...</option>
                    <option value="1">TCRI 1</option>
                    <option value="2">TCRI 2</option>
                    <option value="3">TCRI 3</option>
                    <option value="4">TCRI 4</option>
                    <option value="5">TCRI 5</option>
                    <option value="6">TCRI 6</option>
                    <option value="7">TCRI 7</option>
                    <option value="8">TCRI 8</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç™¼è¡Œç¸½é¡ (å„„å…ƒ)</label>
                <input type="number" id="issueAmount" step="0.1" placeholder="å¦‚ï¼š10">
            </div>
        </div>
        
        <!-- ç«¶æ‹è³‡æ–™ -->
        <div class="form-section">
            <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
            <div class="form-group">
                <label>ç†è«–åƒ¹æ ¼ (å…ƒ) *</label>
                <input type="number" id="theoPrice" step="0.01" placeholder="å¦‚ï¼š105.5">
                <div style="font-size:11px; color:#888; margin-top:4px;">= è‚¡åƒ¹ Ã· è½‰æ›åƒ¹ Ã— 100</div>
            </div>
            <div class="form-group">
                <label>è‚¡ç¥¨æ”¶ç›¤åƒ¹ (å…ƒ)</label>
                <input type="number" id="stockPrice" step="0.01" placeholder="é¸å¡«ï¼Œç”¨æ–¼è¨ˆç®—ç†è«–åƒ¹">
            </div>
            <div class="form-group">
                <label>è½‰æ›åƒ¹æ ¼ (å…ƒ)</label>
                <input type="number" id="convPrice" step="0.01" placeholder="é¸å¡«ï¼Œç”¨æ–¼è¨ˆç®—ç†è«–åƒ¹">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-primary" onclick="runPrediction()" style="flex:1;">ğŸ”® AIé æ¸¬</button>
            <button type="button" class="btn btn-reset" onclick="resetForm()">é‡ç½®</button>
        </div>
    </form>
</div>

<!-- å³å´ï¼šçµæœé¢æ¿ -->
<div class="panel">
    <h2>ğŸ¯ AIé æ¸¬çµæœ</h2>
    <div id="resultArea">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>è¼‰å…¥è³‡æ–™ä¸­...</div>
        </div>
    </div>
    
    <!-- å¸‚å ´æ°›åœ -->
    <div class="atmosphere-card" id="atmosphereCard" style="display:none;">
        <div class="atmosphere-title">ğŸ“Š å¸‚å ´æ°›åœåˆ†æ</div>
        <div class="atmosphere-grid">
            <div class="atmosphere-item">
                <div class="atmosphere-value" id="recentAvgPremium">--</div>
                <div class="atmosphere-label">è¿‘æœŸå¹³å‡æº¢åƒ¹</div>
            </div>
            <div class="atmosphere-item">
                <div class="atmosphere-value" id="recentAvgMult">--</div>
                <div class="atmosphere-label">è¿‘æœŸå¹³å‡å€æ•¸</div>
            </div>
        </div>
    </div>
    
    <!-- æ­·å²æŸ¥è©¢ -->
    <div style="margin-top: 20px;">
        <h3 style="font-size: 14px; color: #667eea; margin-bottom: 10px;">ğŸ“š è¿‘æœŸç«¶æ‹æ¡ˆä¾‹</h3>
        <div id="historyTable">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>
```

</div>
</div>

<script>
// ==========================================
// å…¨åŸŸè®Šæ•¸
// ==========================================
let auctionData = [];      // ç«¶æ‹æ­·å²è³‡æ–™
let issueData = [];        // å¾…ç™¼è¡Œè³‡æ–™
let industryData = {};     // ç”¢æ¥­åˆ†é¡
const DATA_PATH = 'data/00_cb/';

// ==========================================
// AICore ç·šæ€§è¿´æ­¸é æ¸¬æ¨¡çµ„ï¼ˆç²¾ç°¡ç‰ˆï¼‰
// ==========================================
const AICore = {
    // æœ‰æ“”ä¿CBé æ¸¬ï¼šæº¢åƒ¹ = 65 - 0.56 Ã— ç†è«–åƒ¹
    predictGuaranteed: function(theoPrice, tcri, industry) {
        let basePremium = 65 - 0.56 * theoPrice;
        
        // TCRIèª¿æ•´
        const tcriMap = {4: 0, 5: -1, 6: 1, 7: -1, 8: 1, 9: -2};
        let tcriAdj = tcriMap[tcri] || 0;
        
        // ç”¢æ¥­èª¿æ•´
        let industryAdj = 0;
        const hotIndustries = ['é‹¼éµå·¥æ¥­', 'åŠå°é«”æ¥­', 'é‹å‹•ä¼‘é–’', 'ç¶ èƒ½ç’°ä¿'];
        const coldIndustries = ['é›»å­é›¶çµ„ä»¶æ¥­', 'é€šä¿¡ç¶²è·¯æ¥­', 'ç”ŸæŠ€é†«ç™‚æ¥­'];
        if (hotIndustries.includes(industry)) industryAdj = 2;
        else if (coldIndustries.includes(industry)) industryAdj = -2;
        
        let totalPremium = Math.max(basePremium + tcriAdj + industryAdj, 0);
        
        return {
            predictedPrice: theoPrice + totalPremium,
            basePremium, tcriAdj, industryAdj, totalPremium,
            model: 'guaranteed',
            formula: '65 - 0.56Ã—ç†è«–åƒ¹',
            accuracy: { mae: 3.38, within5: 78.2 }
        };
    },
    
    // ç„¡æ“”ä¿CBé æ¸¬ï¼šæº¢åƒ¹ = 82 - 0.75 Ã— ç†è«–åƒ¹
    predictNonGuaranteed: function(theoPrice, tcri, industry) {
        let basePremium = 82 - 0.75 * theoPrice;
        
        // TCRIèª¿æ•´ï¼ˆç„¡æ“”ä¿æ•ˆæœæ›´å¤§ï¼‰
        const tcriMap = {3: 3, 4: 1, 5: 3, 6: 0, 7: -3, 8: -6};
        let tcriAdj = tcriMap[tcri] || 0;
        
        // ç”¢æ¥­èª¿æ•´
        let industryAdj = 0;
        const hotIndustries = ['å…¶ä»–é›»å­æ¥­', 'é€šä¿¡ç¶²è·¯æ¥­', 'é‹¼éµå·¥æ¥­', 'æ±½è»Šå·¥æ¥­'];
        const coldIndustries = ['å…‰é›»æ¥­', 'å»ºæç‡Ÿé€ æ¥­', 'ç”ŸæŠ€é†«ç™‚æ¥­'];
        if (hotIndustries.includes(industry)) industryAdj = 2;
        else if (coldIndustries.includes(industry)) industryAdj = -3;
        
        let totalPremium = basePremium + tcriAdj + industryAdj;
        
        return {
            predictedPrice: theoPrice + totalPremium,
            basePremium, tcriAdj, industryAdj, totalPremium,
            model: 'nonGuaranteed',
            formula: '82 - 0.75Ã—ç†è«–åƒ¹',
            accuracy: { mae: 3.85, within5: 65.0 }
        };
    },
    
    // çµ±ä¸€é æ¸¬å…¥å£
    predict: function(theoPrice, guarantee, tcri, industry) {
        if (!theoPrice || theoPrice <= 0) return null;
        const isGuaranteed = (guarantee === 'æœ‰æ“”ä¿' || guarantee === 'æœ‰');
        const tcriNum = parseInt(tcri) || 5;
        
        if (isGuaranteed) {
            return this.predictGuaranteed(theoPrice, tcriNum, industry);
        } else {
            return this.predictNonGuaranteed(theoPrice, tcriNum, industry);
        }
    },
    
    // è¨ˆç®—ç­–ç•¥åƒ¹æ ¼ï¼ˆåŸºæ–¼é»ƒé‡‘æ¯”ä¾‹ï¼‰
    calcStrategies: function(prediction, theoPrice) {
        if (!prediction) return null;
        
        const std = prediction.model === 'guaranteed' ? 5.5 : 6.5;
        const strategyStd = std * theoPrice / 100;
        const basePrice = prediction.predictedPrice;
        const absoluteMin = Math.max(100, theoPrice);
        
        return {
            conservative: Math.max(basePrice - 0.618 * strategyStd, absoluteMin),
            balanced: Math.max(basePrice, absoluteMin),
            aggressive: Math.max(basePrice + 0.618 * strategyStd, absoluteMin),
            winProb: { conservative: 27, balanced: 50, aggressive: 73 }
        };
    }
};

// ==========================================
// è³‡æ–™è¼‰å…¥
// ==========================================
async function loadData() {
    try {
        // è¼‰å…¥ç«¶æ‹æ­·å²
        const auctionRes = await fetch(DATA_PATH + '04_auction.csv');
        if (auctionRes.ok) {
            const text = await auctionRes.text();
            auctionData = parseCSV(text);
            console.log('âœ… è¼‰å…¥ç«¶æ‹è³‡æ–™:', auctionData.length, 'ç­†');
        }
        
        // è¼‰å…¥å¾…ç™¼è¡Œ
        const issueRes = await fetch(DATA_PATH + '06_issue.csv');
        if (issueRes.ok) {
            const text = await issueRes.text();
            issueData = parseCSV(text);
            console.log('âœ… è¼‰å…¥å¾…ç™¼è¡Œè³‡æ–™:', issueData.length, 'ç­†');
        }
        
        // è¼‰å…¥ç”¢æ¥­åˆ†é¡
        const indRes = await fetch(DATA_PATH + '16_industry.csv');
        if (indRes.ok) {
            const text = await indRes.text();
            const rows = parseCSV(text);
            rows.forEach(r => {
                if (r['ç”¢æ¥­åç¨±']) industryData[r['ç”¢æ¥­åç¨±']] = r;
            });
        }
        
        initUI();
        updateStats();
        renderHistory();
        
    } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
        document.getElementById('resultArea').innerHTML = '<div style="color:red; padding:20px;">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª data/00_cb/ è³‡æ–™å¤¾å­˜åœ¨</div>';
    }
}

// CSV è§£æ
function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        if (values.length === headers.length) {
            const row = {};
            headers.forEach((h, j) => row[h] = values[j]);
            data.push(row);
        }
    }
    return data;
}

// ==========================================
// UI åˆå§‹åŒ–
// ==========================================
function initUI() {
    // å¡«å……ç”¢æ¥­ä¸‹æ‹‰
    const industrySelect = document.getElementById('industry');
    const industries = [...new Set(auctionData.map(d => d['ç”¢æ¥­åˆ¥'] || d['ç”¢æ¥­']).filter(Boolean))];
    industries.sort().forEach(ind => {
        const opt = document.createElement('option');
        opt.value = ind;
        opt.textContent = ind;
        industrySelect.appendChild(opt);
    });
    
    // å¡«å……åˆ¸å•†ä¸‹æ‹‰
    const brokerSelect = document.getElementById('broker');
    const brokers = [...new Set(auctionData.map(d => d['ä¸»è¾¦åˆ¸å•†'] || d['åˆ¸å•†']).filter(Boolean))];
    brokers.sort().forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        brokerSelect.appendChild(opt);
    });
    
    // å¡«å……é–ƒé›»å¸¶å…¥
    populateQuickSelect();
    
    // ç†è«–åƒ¹è‡ªå‹•è¨ˆç®—
    document.getElementById('stockPrice').addEventListener('input', calcTheoPrice);
    document.getElementById('convPrice').addEventListener('input', calcTheoPrice);
    
    // åˆå§‹çµæœå€åŸŸ
    document.getElementById('resultArea').innerHTML = `
        <div style="text-align:center; padding:40px; color:#888;">
            <div style="font-size:48px; margin-bottom:15px;">ğŸ¯</div>
            <div>è«‹è¼¸å…¥ç«¶æ‹æ¢ä»¶å¾Œé»æ“Šã€ŒAIé æ¸¬ã€</div>
        </div>
    `;
}

function populateQuickSelect() {
    const select = document.getElementById('quickSelect');
    
    // å¾…ç«¶æ‹
    const pending = issueData.filter(d => {
        const method = d['ç™¼è¡Œæ–¹å¼'] || d['æ‰¿éŠ·æ–¹å¼'] || '';
        return method.includes('ç«¶æ‹') || method.includes('ç«¶åƒ¹');
    });
    
    if (pending.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'ğŸ”¥ å¾…ç«¶æ‹';
        pending.forEach(d => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify(d);
            opt.textContent = `${d['CBç°¡ç¨±'] || d['CBä»£è™Ÿ']} - ${d['ç”¢æ¥­åˆ¥'] || ''}`;
            group.appendChild(opt);
        });
        select.appendChild(group);
    }
    
    // è¿‘æœŸå®Œæˆ
    const recent = auctionData
        .sort((a, b) => new Date(b['é–‹æ¨™æ—¥æœŸ'] || b['ç«¶æ‹æ—¥']) - new Date(a['é–‹æ¨™æ—¥æœŸ'] || a['ç«¶æ‹æ—¥']))
        .slice(0, 10);
    
    if (recent.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'ğŸ“š è¿‘æœŸæ¡ˆä¾‹';
        recent.forEach(d => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify(d);
            opt.textContent = `${d['CBç°¡ç¨±'] || d['CBä»£è™Ÿ']} - ${d['é–‹æ¨™æ—¥æœŸ'] || d['ç«¶æ‹æ—¥']}`;
            group.appendChild(opt);
        });
        select.appendChild(group);
    }
    
    select.addEventListener('change', handleQuickSelect);
}

function handleQuickSelect() {
    const select = document.getElementById('quickSelect');
    if (!select.value) return;
    
    try {
        const data = JSON.parse(select.value);
        
        document.getElementById('cbName').value = data['CBç°¡ç¨±'] || data['CBä»£è™Ÿ'] || '';
        document.getElementById('industry').value = data['ç”¢æ¥­åˆ¥'] || data['ç”¢æ¥­'] || '';
        document.getElementById('broker').value = data['ä¸»è¾¦åˆ¸å•†'] || data['åˆ¸å•†'] || '';
        document.getElementById('guarantee').value = data['æ“”ä¿'] || '';
        document.getElementById('rating').value = data['ä¿¡ç”¨è©•ç­‰'] || data['TCRI'] || '';
        document.getElementById('issueAmount').value = data['ç™¼è¡Œç¸½é¡'] || '';
        
        const theo = parseFloat(data['ç†è«–åƒ¹']) || 0;
        if (theo > 0) {
            document.getElementById('theoPrice').value = theo.toFixed(2);
        }
        
    } catch (e) {
        console.error('è§£æå¤±æ•—:', e);
    }
}

function calcTheoPrice() {
    const stock = parseFloat(document.getElementById('stockPrice').value) || 0;
    const conv = parseFloat(document.getElementById('convPrice').value) || 0;
    
    if (stock > 0 && conv > 0) {
        const theo = (stock / conv) * 100;
        document.getElementById('theoPrice').value = theo.toFixed(2);
    }
}

// ==========================================
// çµ±è¨ˆæ›´æ–°
// ==========================================
function updateStats() {
    // ç¸½æ¡ˆä¾‹æ•¸
    document.getElementById('totalCases').textContent = auctionData.length;
    
    // å¹³å‡æŠ•æ¨™å€æ•¸
    const mults = auctionData.map(d => parseFloat(d['æŠ•æ¨™å€æ•¸']) || 0).filter(m => m > 0);
    const avgMult = mults.length > 0 ? (mults.reduce((a, b) => a + b, 0) / mults.length).toFixed(2) : '--';
    document.getElementById('avgMultiplier').textContent = avgMult + 'x';
    
    // å¾…ç«¶æ‹
    const pending = issueData.filter(d => {
        const method = d['ç™¼è¡Œæ–¹å¼'] || d['æ‰¿éŠ·æ–¹å¼'] || '';
        return method.includes('ç«¶æ‹') || method.includes('ç«¶åƒ¹');
    });
    document.getElementById('pendingCount').textContent = pending.length;
    
    // å¸‚å ´æ°›åœ
    updateAtmosphere();
}

function updateAtmosphere() {
    const recent = auctionData
        .sort((a, b) => new Date(b['é–‹æ¨™æ—¥æœŸ'] || 0) - new Date(a['é–‹æ¨™æ—¥æœŸ'] || 0))
        .slice(0, 10);
    
    if (recent.length > 0) {
        const premiums = recent.map(d => {
            const theo = parseFloat(d['ç†è«–åƒ¹']) || 0;
            const minBid = parseFloat(d['æœ€ä½å¾—æ¨™']) || 0;
            return theo > 0 ? ((minBid / theo - 1) * 100) : 0;
        }).filter(p => p !== 0);
        
        const avgPremium = premiums.length > 0 
            ? (premiums.reduce((a, b) => a + b, 0) / premiums.length).toFixed(2) 
            : '--';
        
        const mults = recent.map(d => parseFloat(d['æŠ•æ¨™å€æ•¸']) || 0).filter(m => m > 0);
        const avgMult = mults.length > 0 
            ? (mults.reduce((a, b) => a + b, 0) / mults.length).toFixed(2) 
            : '--';
        
        document.getElementById('recentAvgPremium').textContent = avgPremium + '%';
        document.getElementById('recentAvgMult').textContent = avgMult + 'x';
        document.getElementById('atmosphereCard').style.display = 'block';
    }
}

// ==========================================
// AI é æ¸¬
// ==========================================
function runPrediction() {
    const theoPrice = parseFloat(document.getElementById('theoPrice').value) || 0;
    const guarantee = document.getElementById('guarantee').value;
    const rating = document.getElementById('rating').value;
    const industry = document.getElementById('industry').value;
    const cbName = document.getElementById('cbName').value;
    
    if (theoPrice <= 0) {
        alert('è«‹è¼¸å…¥ç†è«–åƒ¹æ ¼');
        return;
    }
    
    if (!guarantee) {
        alert('è«‹é¸æ“‡æ“”ä¿æƒ…æ³');
        return;
    }
    
    // åŸ·è¡Œé æ¸¬
    const prediction = AICore.predict(theoPrice, guarantee, rating, industry);
    const strategies = AICore.calcStrategies(prediction, theoPrice);
    
    if (!prediction || !strategies) {
        alert('é æ¸¬å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥');
        return;
    }
    
    // æŸ¥æ‰¾ç›¸ä¼¼æ¡ˆä¾‹
    const similar = findSimilarCases(theoPrice, guarantee, industry);
    
    // é¡¯ç¤ºçµæœ
    displayResult(prediction, strategies, theoPrice, cbName, similar);
}

function findSimilarCases(theoPrice, guarantee, industry) {
    return auctionData.filter(d => {
        const theo = parseFloat(d['ç†è«–åƒ¹']) || 0;
        const guar = d['æ“”ä¿'] || '';
        const ind = d['ç”¢æ¥­åˆ¥'] || d['ç”¢æ¥­'] || '';
        
        // ç†è«–åƒ¹å€é–“ç›¸è¿‘ï¼ˆÂ±10ï¼‰
        const theoDiff = Math.abs(theo - theoPrice);
        if (theoDiff > 10) return false;
        
        // æ“”ä¿é¡å‹ç›¸åŒ
        const isGuaranteed = (guarantee === 'æœ‰æ“”ä¿' || guarantee === 'æœ‰');
        const dataGuaranteed = (guar === 'æœ‰æ“”ä¿' || guar === 'æœ‰');
        if (isGuaranteed !== dataGuaranteed) return false;
        
        return true;
    }).sort((a, b) => new Date(b['é–‹æ¨™æ—¥æœŸ'] || 0) - new Date(a['é–‹æ¨™æ—¥æœŸ'] || 0)).slice(0, 5);
}

function displayResult(prediction, strategies, theoPrice, cbName, similar) {
    const isGuaranteed = prediction.model === 'guaranteed';
    const modelColor = isGuaranteed ? '#2e7d32' : '#1565c0';
    const modelName = isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    let html = `
        <!-- é æ¸¬çµæœå¡ç‰‡ -->
        <div class="result-card">
            <div class="result-title">
                ğŸ¯ ${cbName || 'CB'} é æ¸¬çµæœ
                <span style="font-size:12px; background:${modelColor}; color:white; padding:3px 10px; border-radius:12px; margin-left:10px;">${modelName}æ¨¡å‹</span>
            </div>
            
            <!-- ç­–ç•¥åƒ¹æ ¼ -->
            <div class="price-grid">
                <div class="price-item conservative">
                    <div class="price-label">ä¿å®ˆç­–ç•¥ (æˆæœ¬å„ªå…ˆ)</div>
                    <div class="price-value">${strategies.conservative.toFixed(2)}</div>
                    <div style="font-size:11px; color:#888;">å‹ç‡ ${strategies.winProb.conservative}%</div>
                </div>
                <div class="price-item balanced">
                    <div class="price-label">ç©©å¥ç­–ç•¥ (å‡è¡¡)</div>
                    <div class="price-value">${strategies.balanced.toFixed(2)}</div>
                    <div style="font-size:11px; color:#888;">å‹ç‡ ${strategies.winProb.balanced}%</div>
                </div>
                <div class="price-item aggressive">
                    <div class="price-label">ç©æ¥µç­–ç•¥ (ç¢ºä¿å¾—æ¨™)</div>
                    <div class="price-value">${strategies.aggressive.toFixed(2)}</div>
                    <div style="font-size:11px; color:#888;">å‹ç‡ ${strategies.winProb.aggressive}%</div>
                </div>
            </div>
        </div>
        
        <!-- é æ¸¬æ˜ç´° -->
        <div class="result-card" style="background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%); border-color: #ddd;">
            <div class="result-title" style="color:#666;">ğŸ“ é æ¸¬æ˜ç´°</div>
            <div class="info-row">
                <span class="info-label">é æ¸¬å…¬å¼</span>
                <span class="info-value">${prediction.formula}</span>
            </div>
            <div class="info-row">
                <span class="info-label">è¼¸å…¥ç†è«–åƒ¹</span>
                <span class="info-value">${theoPrice.toFixed(2)} å…ƒ</span>
            </div>
            <div class="info-row">
                <span class="info-label">åŸºç¤æº¢åƒ¹</span>
                <span class="info-value">${prediction.basePremium >= 0 ? '+' : ''}${prediction.basePremium.toFixed(2)} å…ƒ</span>
            </div>
            <div class="info-row">
                <span class="info-label">TCRIèª¿æ•´</span>
                <span class="info-value" style="color:${prediction.tcriAdj >= 0 ? '#4caf50' : '#f44336'};">${prediction.tcriAdj >= 0 ? '+' : ''}${prediction.tcriAdj} å…ƒ</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç”¢æ¥­èª¿æ•´</span>
                <span class="info-value" style="color:${prediction.industryAdj >= 0 ? '#4caf50' : '#f44336'};">${prediction.industryAdj >= 0 ? '+' : ''}${prediction.industryAdj} å…ƒ</span>
            </div>
            <div class="info-row" style="background:#e8f5e9; margin:10px -15px -15px; padding:12px 15px; border-radius:0 0 10px 10px;">
                <span class="info-label" style="font-weight:bold;">é æ¸¬æœ€ä½å¾—æ¨™åƒ¹</span>
                <span class="info-value" style="font-size:18px; color:${modelColor};">${prediction.predictedPrice.toFixed(2)} å…ƒ</span>
            </div>
        </div>
    `;
    
    // ç›¸ä¼¼æ¡ˆä¾‹
    if (similar.length > 0) {
        html += `
            <div class="result-card" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border-color: #ffc107;">
                <div class="result-title" style="color:#f57c00;">ğŸ“Š ç›¸ä¼¼æ¡ˆä¾‹åƒè€ƒ (${similar.length}ç­†)</div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>CBåç¨±</th>
                            <th>ç†è«–åƒ¹</th>
                            <th>æœ€ä½å¾—æ¨™</th>
                            <th>æº¢åƒ¹</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        similar.forEach(d => {
            const theo = parseFloat(d['ç†è«–åƒ¹']) || 0;
            const minBid = parseFloat(d['æœ€ä½å¾—æ¨™']) || 0;
            const premium = theo > 0 ? ((minBid / theo - 1) * 100).toFixed(2) : '--';
            
            html += `
                <tr>
                    <td>${d['CBç°¡ç¨±'] || d['CBä»£è™Ÿ'] || '--'}</td>
                    <td>${theo.toFixed(2)}</td>
                    <td>${minBid.toFixed(2)}</td>
                    <td style="color:${parseFloat(premium) >= 0 ? '#4caf50' : '#f44336'};">${premium}%</td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
    }
    
    document.getElementById('resultArea').innerHTML = html;
}

// ==========================================
// æ­·å²è¡¨æ ¼
// ==========================================
function renderHistory() {
    const recent = auctionData
        .sort((a, b) => new Date(b['é–‹æ¨™æ—¥æœŸ'] || 0) - new Date(a['é–‹æ¨™æ—¥æœŸ'] || 0))
        .slice(0, 15);
    
    if (recent.length === 0) {
        document.getElementById('historyTable').innerHTML = '<div style="color:#888; padding:20px;">æš«ç„¡è³‡æ–™</div>';
        return;
    }
    
    let html = `
        <table class="history-table">
            <thead>
                <tr>
                    <th>é–‹æ¨™æ—¥</th>
                    <th>CBåç¨±</th>
                    <th>æ“”ä¿</th>
                    <th>ç†è«–åƒ¹</th>
                    <th>æœ€ä½å¾—æ¨™</th>
                    <th>å€æ•¸</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    recent.forEach(d => {
        const date = (d['é–‹æ¨™æ—¥æœŸ'] || d['ç«¶æ‹æ—¥'] || '').substring(0, 10);
        const theo = parseFloat(d['ç†è«–åƒ¹']) || 0;
        const minBid = parseFloat(d['æœ€ä½å¾—æ¨™']) || 0;
        const mult = parseFloat(d['æŠ•æ¨™å€æ•¸']) || 0;
        const guar = (d['æ“”ä¿'] || '').includes('æœ‰') ? 'æœ‰' : 'ç„¡';
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${d['CBç°¡ç¨±'] || d['CBä»£è™Ÿ'] || '--'}</td>
                <td><span style="background:${guar === 'æœ‰' ? '#e8f5e9' : '#fff3e0'}; padding:2px 6px; border-radius:4px; font-size:11px;">${guar}</span></td>
                <td>${theo.toFixed(2)}</td>
                <td style="font-weight:bold;">${minBid.toFixed(2)}</td>
                <td>${mult.toFixed(2)}x</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    document.getElementById('historyTable').innerHTML = html;
}

function resetForm() {
    document.getElementById('evalForm').reset();
    document.getElementById('quickSelect').value = '';
    document.getElementById('resultArea').innerHTML = `
        <div style="text-align:center; padding:40px; color:#888;">
            <div style="font-size:48px; margin-bottom:15px;">ğŸ¯</div>
            <div>è«‹è¼¸å…¥ç«¶æ‹æ¢ä»¶å¾Œé»æ“Šã€ŒAIé æ¸¬ã€</div>
        </div>
    `;
}

// ==========================================
// å•Ÿå‹•
// ==========================================
document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
